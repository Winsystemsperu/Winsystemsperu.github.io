<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Asignaci√≥n de Incidencias - Winsystems</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --ws-primary: #1e40af;
            --ws-secondary: #3b82f6;
            --ws-accent: #f97316;
            --ws-light: #f0f7ff;
            --ws-dark: #1e293b;
            --ws-red: #dc2626;
            --ws-amber: #f59e0b;
        }

        /* FIX FINAL para el indicador de Supabase Realtime */
        div[style*="background-color: rgb(34, 197, 94)"][style*="position: fixed"],
        #supabase-realtime-status-indicator {
            display: none !important;
            visibility: hidden !important;
            opacity: 0 !important;
            z-index: -9999 !important;
            width: 0 !important;
            height: 0 !important;
            pointer-events: none !important;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, var(--ws-light) 0%, #e0f2fe 100%);
            min-height: 100vh;
        }

        .incident-card {
            transition: all 0.3s ease;
            border-radius: 0.75rem;
            background-color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            opacity: 1;
            transform: translateY(0);
            position: relative;
            overflow: hidden;
        }

        .incident-card::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 6px;
        }

        .incident-card.inoperativo::before {
            background-color: var(--ws-red);
        }

        .incident-card.pendiente::before {
            background-color: var(--ws-amber);
        }

        .incident-card.asignada::before {
            background-color: var(--ws-primary);
        }

        .incident-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.1);
        }

        .status-badge {
            font-weight: 700;
        }

        .attention-alert {
            animation: subtle-pulse 3s infinite ease-in-out;
        }

        @keyframes subtle-pulse {

            0%,
            100% {
                box-shadow: 0 0 0 0 rgba(220, 38, 38, 0.2);
            }

            50% {
                box-shadow: 0 0 0 6px rgba(220, 38, 38, 0);
            }
        }

        .stats-card {
            background: white;
            border-radius: 0.75rem;
            padding: 1.5rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.2s;
        }

        .stats-card:hover {
            transform: translateY(-2px);
        }

        .technician-select {
            background: #f9fafb;
            border: 1px solid #d1d5db;
            color: #1f2937;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
        }

        .assign-button {
            border-radius: 0.5rem;
            font-size: 0.875rem;
            padding: 0.5rem 1rem;
        }

        .report-details-box {
            line-height: 1.4;
            text-align: justify;
        }

        .technician-card {
            transition: all 0.3s ease;
        }

        .technician-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(0, 0, 0, 0.1);
        }

        .status-dot {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        /* Modal Styles */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .modal-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .modal-content {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .modal-overlay.active .modal-content {
            transform: scale(1);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            font-weight: 500;
            margin-bottom: 0.5rem;
            color: #374151;
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
            transition: border-color 0.2s;
        }

        .form-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        /* Nuevos estilos para pesta√±as */
        .tab-container {
            background: white;
            border-radius: 1rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .tab-header {
            display: flex;
            border-bottom: 1px solid #e5e7eb;
            overflow-x: auto;
        }

        .tab-button {
            padding: 1rem 1.5rem;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 2px solid transparent;
            transition: all 0.2s;
            white-space: nowrap;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .tab-button:hover {
            color: #374151;
            background-color: #f9fafb;
        }

        .tab-button.active {
            color: #3b82f6;
            border-bottom-color: #3b82f6;
            background-color: #f0f7ff;
        }

        .tab-content {
            display: none;
            padding: 1.5rem;
        }

        .tab-content.active {
            display: block;
        }

        /* Mejoras para tarjetas de incidencias */
        .incident-header {
            cursor: pointer;
            padding: 1rem 1.5rem;
        }

        .incident-details {
            padding: 0 1.5rem 1.5rem;
            border-top: 1px solid #f3f4f6;
        }

        /* Barra de b√∫squeda */
        .search-container {
            position: relative;
            margin-bottom: 1.5rem;
        }

        .search-input {
            width: 100%;
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.75rem;
            font-size: 0.875rem;
            transition: all 0.2s;
        }

        .search-input:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            color: #9ca3af;
        }

        /* Botones de acci√≥n r√°pida */
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .action-btn {
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all 0.2s;
        }

        .action-btn.primary {
            background-color: #3b82f6;
            color: white;
        }

        .action-btn.primary:hover {
            background-color: #2563eb;
        }

        .action-btn.secondary {
            background-color: #f3f4f6;
            color: #374151;
        }

        .action-btn.secondary:hover {
            background-color: #e5e7eb;
        }

        /* Indicadores de estado mejorados */
        .priority-indicator {
            display: inline-flex;
            align-items: center;
            gap: 0.25rem;
            padding: 0.25rem 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .priority-high {
            background-color: #fef2f2;
            color: #dc2626;
        }

        .priority-medium {
            background-color: #fffbeb;
            color: #d97706;
        }

        .priority-low {
            background-color: #f0f9ff;
            color: #0369a1;
        }

        /* Mejoras responsive */
        @media (max-width: 768px) {
            .tab-button {
                padding: 0.75rem 1rem;
                font-size: 0.875rem;
            }

            .tab-content {
                padding: 1rem;
            }

            .incident-header {
                padding: 1rem;
            }

            .incident-details {
                padding: 0 1rem 1rem;
            }
        }

        /* Nuevos estilos para disponibilidad de t√©cnicos */
        .availability-toggle {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
        }

        .availability-toggle input {
            display: none;
        }

        .availability-toggle .toggle-slider {
            width: 44px;
            height: 24px;
            background-color: #d1d5db;
            border-radius: 24px;
            position: relative;
            transition: all 0.3s;
        }

        .availability-toggle .toggle-slider::before {
            content: '';
            position: absolute;
            width: 18px;
            height: 18px;
            border-radius: 50%;
            background-color: white;
            top: 3px;
            left: 3px;
            transition: all 0.3s;
        }

        .availability-toggle input:checked+.toggle-slider {
            background-color: #10b981;
        }

        .availability-toggle input:checked+.toggle-slider::before {
            transform: translateX(20px);
        }

        /* Estilo para dos columnas */
        .two-columns {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1.5rem;
        }

        @media (max-width: 1024px) {
            .two-columns {
                grid-template-columns: 1fr;
            }
        }

        /* Animaci√≥n de puntos de carga */
        .loading-dots::after {
            content: ' .';
            animation: dots 1.4s infinite;
            animation-delay: .2s;
            display: inline-block;
        }

        @keyframes dots {
            0% {
                content: ' .';
            }

            33% {
                content: ' ..';
            }

            66% {
                content: ' ...';
            }

            100% {
                content: ' .';
            }
        }
    </style>
</head>

<body class="text-gray-800">

    <div id="loading-overlay"
        class="fixed inset-0 bg-white bg-opacity-90 flex flex-col items-center justify-center z-50">
        <div class="bg-white p-8 rounded-2xl shadow-xl flex flex-col items-center">
            <i data-lucide="loader-2" class="animate-spin h-12 w-12 text-blue-600 mb-4"></i>
            <p class="text-gray-600 font-medium">Cargando incidencias<span class="loading-dots"></span></p>
        </div>
    </div>

    <div id="toast"
        class="fixed top-4 right-4 bg-green-500 text-white p-4 rounded-lg shadow-lg z-50 transform translate-x-full transition-transform duration-300">
        <div class="flex items-center gap-2">
            <i data-lucide="check-circle" class="w-5 h-5"></i>
            <span id="toast-message">Tarea asignada exitosamente!</span>
        </div>
    </div>

    <div id="create-incident-modal" class="modal-overlay">
        <div class="modal-content">
            <div class="p-6 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <h2 class="text-xl font-bold text-gray-900">Crear Nueva Incidencia</h2>
                    <button id="close-modal" class="text-gray-400 hover:text-gray-600 transition-colors">
                        <i data-lucide="x" class="w-6 h-6"></i>
                    </button>
                </div>
            </div>

            <div class="p-6">
                <form id="create-incident-form">
                    <div class="space-y-4">
                        <div class="form-group">
                            <label for="sala" class="form-label">Sala</label>
                            <input type="text" id="sala" class="form-input" placeholder="Ingrese el nombre de la sala"
                                required>
                        </div>

                        <div class="form-group">
                            <label for="serie" class="form-label">Serie de la M√°quina</label>
                            <input type="text" id="serie" class="form-input"
                                placeholder="Ingrese la serie de la m√°quina" required>
                        </div>

                        <div class="form-group">
                            <label for="tecnico" class="form-label">T√©cnico Asignado</label>
                            <select id="tecnico" class="form-input" required>
                                <option value="" disabled selected>Seleccione un t√©cnico</option>
                            </select>
                        </div>

                        <div class="form-group">
                            <label for="diagnostico" class="form-label">Diagn√≥stico Inicial</label>
                            <textarea id="diagnostico" class="form-input form-textarea"
                                placeholder="Describa el problema o diagn√≥stico inicial" required></textarea>
                        </div>
                    </div>

                    <div class="flex justify-end gap-3 mt-8 pt-6 border-t border-gray-200">
                        <button type="button" id="cancel-create"
                            class="px-4 py-2 text-gray-700 bg-gray-100 rounded-lg hover:bg-gray-200 transition-colors">
                            Cancelar
                        </button>
                        <button type="submit"
                            class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2">
                            <i data-lucide="plus" class="w-4 h-4"></i>
                            Crear y Asignar
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl">
        <header
            class="mb-8 md:mb-12 flex flex-wrap justify-between items-center bg-white rounded-2xl p-6 shadow-md border-b-4 border-blue-600">
            <div class="flex items-center space-x-4">
                <div class="w-10 h-10 bg-blue-600 rounded-lg flex items-center justify-center">
                    <i data-lucide="wrench" class="w-6 h-6 text-white"></i>
                </div>
                <div>
                    <h1 class="text-xl md:text-2xl font-bold text-gray-900">Gesti√≥n de Incidencias</h1>
                    <p class="text-sm text-gray-500 font-medium">Asignaci√≥n r√°pida y seguimiento de tareas</p>
                </div>
            </div>
            <div class="flex items-center gap-4 mt-4 md:mt-0">
                <button id="create-incident-btn"
                    class="bg-green-600 text-white px-4 py-2 rounded-lg hover:bg-green-700 transition-all duration-300 flex items-center gap-2 text-sm">
                    <i data-lucide="plus" class="w-4 h-4"></i>
                    Nueva Incidencia
                </button>
                <a href="./home.html"
                    class="bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-300 flex items-center gap-2 text-sm">
                    <i data-lucide="layout-dashboard" class="w-4 h-4"></i>
                    Dashboard
                </a>
                <div class="flex items-center gap-2 text-sm text-gray-500">
                    <i data-lucide="refresh-cw" class="w-4 h-4"></i>
                    <span>Actualizado: <span id="last-update" class="font-medium">Ahora</span></span>
                </div>
            </div>
        </header>

        <div id="stats-container"
            class="grid grid-cols-2 lg:grid-cols-5 gap-6 mb-8 opacity-0 transition-opacity duration-500">
        </div>

        <div class="tab-container mb-8">
            <div class="tab-header">
                <button class="tab-button active" data-tab="urgentes">
                    <i data-lucide="alert-triangle" class="w-4 h-4"></i>
                    Urgentes
                    <span id="urgentes-count"
                        class="ml-1 bg-red-100 text-red-800 px-2 py-0.5 rounded-full text-xs">0</span>
                </button>
                <button class="tab-button" data-tab="pendientes">
                    <i data-lucide="clock" class="w-4 h-4"></i>
                    Pendientes
                    <span id="pendientes-count"
                        class="ml-1 bg-amber-100 text-amber-800 px-2 py-0.5 rounded-full text-xs">0</span>
                </button>
                <button class="tab-button" data-tab="asignadas">
                    <i data-lucide="user-check" class="w-4 h-4"></i>
                    Asignadas
                    <span id="asignadas-count"
                        class="ml-1 bg-blue-100 text-blue-800 px-2 py-0.5 rounded-full text-xs">0</span>
                </button>
                <button class="tab-button" data-tab="tecnicos">
                    <i data-lucide="users" class="w-4 h-4"></i>
                    T√©cnicos
                    <span id="tecnicos-count"
                        class="ml-1 bg-green-100 text-green-800 px-2 py-0.5 rounded-full text-xs">0</span>
                </button>
            </div>

            <div class="tab-content active" id="urgentes-tab">
                <div class="quick-actions">
                    <button id="expand-all-urgentes" class="action-btn secondary">
                        <i data-lucide="chevrons-down" class="w-4 h-4"></i>
                        Expandir Todo
                    </button>
                </div>
                <div class="search-container">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="search-urgentes" class="search-input"
                        placeholder="Buscar en incidencias urgentes...">
                </div>
                <div id="urgentes-container" class="two-columns">
                </div>
            </div>

            <div class="tab-content" id="pendientes-tab">
                <div class="quick-actions">
                    <button id="expand-all-pendientes" class="action-btn secondary">
                        <i data-lucide="chevrons-down" class="w-4 h-4"></i>
                        Expandir Todo
                    </button>
                </div>
                <div class="search-container">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="search-pendientes" class="search-input"
                        placeholder="Buscar en incidencias pendientes...">
                </div>
                <div id="pendientes-container" class="two-columns">
                </div>
            </div>

            <div class="tab-content" id="asignadas-tab">
                <div class="quick-actions">
                    <button id="expand-all-asignadas" class="action-btn secondary">
                        <i data-lucide="chevrons-down" class="w-4 h-4"></i>
                        Expandir Todo
                    </button>
                </div>
                <div class="search-container">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="search-asignadas" class="search-input"
                        placeholder="Buscar en incidencias asignadas...">
                </div>
                <div id="asignadas-container" class="two-columns">
                </div>
            </div>

            <div class="tab-content" id="tecnicos-tab">
                <div class="quick-actions">
                    <button id="sort-tecnicos" class="action-btn secondary">
                        <i data-lucide="arrow-up-down" class="w-4 h-4"></i>
                        Ordenar
                    </button>
                </div>
                <div class="search-container">
                    <i data-lucide="search" class="search-icon w-4 h-4"></i>
                    <input type="text" id="search-tecnicos" class="search-input" placeholder="Buscar t√©cnicos...">
                </div>
                <div id="tecnicos-container"
                    class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-4">
                </div>
            </div>
        </div>

        <footer class="mt-12 pt-6 border-t border-gray-200 text-center text-gray-500 text-sm">
            <p>Winsystems &copy; 2025 - Sistema de Gesti√≥n de Incidencias</p>
        </footer>
    </div>

    <script>
        // --- CONFIG & GLOBAL VARS ---
        const SUPABASE_URL = 'https://qobquktxvhlvtrpeopji.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvYnF1a3R4dmhsdnRycGVvcGppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU2OTc4NDYsImV4cCI6MjA2MTI3Mzg0Nn0.rnubNUWSWEomj5Xwvr65kZLK7Ig_bLC74ajFh9cksFc';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let realtimeSubscription = null;
        let lastSuccessfulIncidents = [];
        let availableTechnicians = [];
        let currentTab = 'urgentes';

        // --- UTILITY FUNCTIONS ---
        function getPeruDateTime() {
            const ahora = new Date();
            const timeZone = 'America/Lima';

            const dateFormatter = new Intl.DateTimeFormat('es-PE', {
                timeZone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const parts = dateFormatter.formatToParts(ahora);
            const day = parts.find(p => p.type === 'day').value;
            const month = parts.find(p => p.type === 'month').value;
            const year = parts.find(p => p.type === 'year').value;
            const fecha = `${year}-${month}-${day}`;

            const hora = ahora.toLocaleTimeString('es-PE', {
                timeZone,
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            return { fecha, hora };
        }

        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');

            if (!toast) {
                console.error("Error: Elemento #toast no encontrado.");
                return;
            }

            const toastIcon = toast.querySelector('i');

            if (!toastIcon) {
                console.error("Error: Elemento <i> dentro de #toast no encontrado.");
                return;
            }

            if (type === 'error') {
                toast.classList.remove('bg-green-500');
                toast.classList.add('bg-red-500');
                toastIcon.setAttribute('data-lucide', 'x-circle');
            } else {
                toast.classList.remove('bg-red-500');
                toast.classList.add('bg-green-500');
                toastIcon.setAttribute('data-lucide', 'check-circle');
            }
            lucide.createIcons();

            toastMessage.textContent = message;
            toast.classList.remove('translate-x-full');

            setTimeout(() => {
                toast.classList.add('translate-x-full');
            }, 3000);
        }

        function updateLastUpdateTime() {
            const now = new Date();
            document.getElementById('last-update').textContent = now.toLocaleTimeString('es-PE');
        }

        /**
         * Parsea una fecha y hora (de Lima) a un objeto Date de JS,
         * forzando la zona horaria correcta.
         */
        function parseLimaDateTime(dateStr, timeStr) {
            if (!dateStr || !timeStr) return null;
            // Asumimos que la BBDD guarda en -05:00 (Lima)
            const limaOffset = '-05:00';
            try {
                return new Date(`${dateStr}T${timeStr}${limaOffset}`);
            } catch (e) {
                console.warn("Fecha/hora no v√°lida:", dateStr, timeStr);
                return null;
            }
        }

        /**
         * Devuelve una cadena de tiempo relativo (ej. "hace 5 min")
         */
        function timeAgo(dateString, timeString) {
            if (!dateString || !timeString) return 'fecha desconocida';

            const incidentDate = parseLimaDateTime(dateString, timeString);
            if (!incidentDate) return 'fecha inv√°lida';

            const now = new Date();
            const seconds = Math.floor((now - incidentDate) / 1000);

            if (isNaN(seconds) || seconds < 0) return 'reci√©n';

            let interval = seconds / 31536000; // a√±os
            if (interval > 1) return `hace ${Math.floor(interval)} a√±os`;
            interval = seconds / 2592000; // meses
            if (interval > 1) return `hace ${Math.floor(interval)} mes(es)`;
            interval = seconds / 86400; // d√≠as
            if (interval > 1) return `hace ${Math.floor(interval)} d√≠as`;
            interval = seconds / 3600; // horas
            if (interval > 1) return `hace ${Math.floor(interval)} h`;
            interval = seconds / 60; // minutos
            if (interval > 1) return `hace ${Math.floor(interval)} min`;

            return `hace ${Math.floor(seconds)} seg`;
        }

        // --- TAB MANAGEMENT ---
        function switchTab(tabName) {
            // Actualizar botones de pesta√±a
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

            // Actualizar contenido de pesta√±a
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(`${tabName}-tab`).classList.add('active');

            currentTab = tabName;
        }

        // --- MODAL FUNCTIONS ---
        function openCreateIncidentModal() {
            const modal = document.getElementById('create-incident-modal');
            modal.classList.add('active');
            loadTechniciansForModal();
            document.getElementById('create-incident-form').reset();
        }

        function closeCreateIncidentModal() {
            const modal = document.getElementById('create-incident-modal');
            modal.classList.remove('active');
            document.getElementById('create-incident-form').reset();
        }

        function loadTechniciansForModal() {
            const select = document.getElementById('tecnico');
            select.innerHTML = '<option value="" disabled selected>Seleccione un t√©cnico</option>';

            if (availableTechnicians.length === 0) {
                select.innerHTML += '<option value="" disabled>No hay t√©cnicos disponibles</option>';
                return;
            }

            // Filtrar solo t√©cnicos disponibles
            const availableTechs = availableTechnicians.filter(tech => tech.disponible !== false);

            availableTechs.forEach(tech => {
                const option = document.createElement('option');
                option.value = tech.id_usuario;
                option.textContent = tech.usuario;
                select.appendChild(option);
            });
        }

        // --- SESSION MANAGEMENT ---
        async function checkCoordinatorSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) {
                window.location.href = './index.html';
                return;
            }

            const { data: tecnicoData, error } = await supabaseClient
                .from('tecnicos')
                .select('cargo, usuario')
                .eq('id_usuario', session.user.id)
                .single();

            if (error || !tecnicoData || (tecnicoData.cargo !== 'Coordinador' && tecnicoData.cargo !== 'admin')) {
                window.location.href = './dashboard.html';
                return;
            }

            await loadAssignmentPage(false);
        }

        function setupRealtimeSubscription(callback) {
            if (realtimeSubscription) {
                supabaseClient.removeChannel(realtimeSubscription);
            }

            const insertChannel = supabaseClient.channel('detalle-insert')
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'detalle'
                    },
                    (payload) => {
                        if (payload.new.estado === 'En Progreso' || payload.new.estado === 'Asignado') {
                            setTimeout(() => callback(true), 1000);
                        }
                    }
                )
                .subscribe();

            const updateChannel = supabaseClient.channel('detalle-update')
                .on(
                    'postgres_changes',
                    {
                        event: 'UPDATE',
                        schema: 'public',
                        table: 'detalle'
                    },
                    (payload) => {
                        if (payload.new.estado === 'En Progreso' || payload.new.estado === 'Asignado') {
                            setTimeout(() => callback(true), 1000);
                        }
                    }
                )
                .subscribe();

            const trabajosChannel = supabaseClient.channel('trabajos-insert')
                .on(
                    'postgres_changes',
                    {
                        event: 'INSERT',
                        schema: 'public',
                        table: 'trabajos'
                    },
                    (payload) => {
                        setTimeout(() => callback(true), 1000);
                    }
                )
                .subscribe();

            realtimeSubscription = [insertChannel, updateChannel, trabajosChannel];
        }

        // --- DATA LOADING ---
        async function loadAssignmentPage(isRealtime) {
            const loadingOverlay = document.getElementById('loading-overlay');
            if (!isRealtime && loadingOverlay) loadingOverlay.style.display = 'flex';

            try {
                const [pendingIncidents, technicians, assignedIncidents] = await Promise.all([
                    fetchPendingIncidents(),
                    fetchTechnicians(),
                    fetchAssignedIncidents()
                ]);

                availableTechnicians = technicians;
                renderStatistics(pendingIncidents, technicians, assignedIncidents);
                renderIncidents(pendingIncidents, technicians);
                renderTechniciansList(technicians);
                renderAssignedIncidents(assignedIncidents);
                updateLastUpdateTime();
                lastSuccessfulIncidents = pendingIncidents;

            } catch (error) {
                console.error("Error loading assignment page:", error);
                showToast("Error cr√≠tico al cargar los datos. Verifique la conexi√≥n a Supabase.", "error");
            } finally {
                if (loadingOverlay && !isRealtime) {
                    loadingOverlay.style.opacity = '0';
                    setTimeout(() => {
                        loadingOverlay.style.display = 'none';
                    }, 500);
                }
            }
        }

        async function fetchPendingIncidents() {
            const { data, error } = await supabaseClient.rpc('get_latest_machine_details');

            if (error) {
                throw new Error("Error en RPC get_latest_machine_details: " + error.message);
            }

            if (!data) return [];

            const pending = data.filter(item => item.estado === 'Inoperativo' || item.estado === 'Pendiente');

            pending.sort((a, b) => {
                const timeA = `${a.fecha_reporte || a.fecha} ${a.hora_reporte || '00:00:00'}`;
                const timeB = `${b.fecha_reporte || b.fecha} ${b.hora_reporte || '00:00:00'}`;

                if (timeA < timeB) return 1;
                if (timeA > timeB) return -1;
                return 0;
            });

            return pending;
        }

        async function fetchAssignedIncidents() {
            try {
                const { data, error } = await supabaseClient
                    .from('detalle')
                    .select(`id_detalle, id_maquina, id_trabajo, diag_ini, estado, tipo_trabajo, trab_realizado, resul,¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† trabajos(id_trabajo, hora_inicio, fecha, id_usuario, id_responsable,¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† tecnicos(id_usuario, usuario, cel, cargo) 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ),¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† maquinas(id_maquina, serie, modelo, id_sala,¬†
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† sala(id_sala, sala, sala_mincetur:sala, distrito) 
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† )
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† `)
                    .in('estado', ['En Progreso', 'Asignado']) // "En Progreso" tambi√©n est√° aqu√≠
                    .order('id_detalle', { ascending: false });

                if (error) throw error;
                return data;
            } catch (error) {
                console.error('Error en fetchAssignedIncidents:', error);
                return [];
            }
        }

        async function fetchTechnicians() {
            const { data, error } = await supabaseClient
                .from('tecnicos')
                .select('id_usuario, usuario, disponible')
                .in('cargo', ['Tecnico', 'Coordinador'])
                .order('usuario');

            if (error) {
                console.error("Error fetching technicians:", error);
                return [];
            }
            return data;
        }

        async function createNewIncident(formData) {
            try {
                console.log("üìù Iniciando creaci√≥n de incidencia:", formData);

                const { fecha, hora } = getPeruDateTime();
                console.log("üïê Fecha y hora generadas:", fecha, hora);

                // 1. Obtener o crear la sala
                console.log("üîç Buscando/creando sala:", formData.sala);
                const { data: salaData, error: salaError } = await supabaseClient
                    .from('sala')
                    .select('id_sala')
                    .eq('sala_mincetur', formData.sala)
                    .single();

                let id_sala;

                if (salaError || !salaData) {
                    console.log("‚ûï Creando nueva sala...");
                    const { data: newSala, error: newSalaError } = await supabaseClient
                        .from('sala')
                        .insert({
                            sala: formData.sala,
                            sala_mincetur: formData.sala,
                            distrito: 'Por definir',
                            provincia: 'Lima',
                            departamento: 'Lima'
                        })
                        .select()
                        .single();

                    if (newSalaError) {
                        console.error("‚ùå Error creando sala:", newSalaError);
                        throw newSalaError;
                    }
                    id_sala = newSala.id_sala;
                    console.log("‚úÖ Sala creada con ID:", id_sala);
                } else {
                    id_sala = salaData.id_sala;
                    console.log("‚úÖ Sala existente con ID:", id_sala);
                }

                // 2. Obtener o crear la m√°quina
                console.log("üîç Buscando/creando m√°quina:", formData.serie);
                const { data: maquinaData, error: maquinaError } = await supabaseClient
                    .from('maquinas')
                    .select('id_maquina')
                    .eq('serie', formData.serie)
                    .single();

                let id_maquina;

                if (maquinaError || !maquinaData) {
                    console.log("‚ûï Creando nueva m√°quina...");
                    const { data: newMaquina, error: newMaquinaError } = await supabaseClient
                        .from('maquinas')
                        .insert({
                            serie: formData.serie,
                            modelo: 'M√°quina Winsystems',
                            id_sala: id_sala
                        })
                        .select()
                        .single();

                    if (newMaquinaError) {
                        console.error("‚ùå Error creando m√°quina:", newMaquinaError);
                        throw newMaquinaError;
                    }
                    id_maquina = newMaquina.id_maquina;
                    console.log("‚úÖ M√°quina creada con ID:", id_maquina);
                } else {
                    id_maquina = maquinaData.id_maquina;
                    console.log("‚úÖ M√°quina existente con ID:", id_maquina);
                }

                // 3. Crear trabajo con el t√©cnico asignado
                console.log("üë®‚Äçüíº Creando trabajo para t√©cnico:", formData.tecnico);
                const { data: newTrabajo, error: trabajoError } = await supabaseClient
                    .from('trabajos')
                    .insert({
                        id_sala: id_sala,
                        id_usuario: formData.tecnico,
                        fecha: fecha,
                        hora_inicio: hora,
                        hora_fin: hora
                    })
                    .select()
                    .single();

                if (trabajoError) {
                    console.error("‚ùå Error creando trabajo:", trabajoError);
                    throw trabajoError;
                }
                console.log("‚úÖ Trabajo creado con ID:", newTrabajo.id_trabajo);

                // 4. Crear detalle con estado "En Progreso"
                console.log("üìã Creando detalle...");
                const { error: detalleError } = await supabaseClient
                    .from('detalle')
                    .insert({
                        id_trabajo: newTrabajo.id_trabajo,
                        id_maquina: id_maquina,
                        diag_ini: formData.diagnostico,
                        estado: 'En Progreso',
                        tipo_trabajo: 'Mantenimiento',
                        fecha_reporte: fecha,
                        hora_reporte: hora
                    });

                if (detalleError) {
                    console.error("‚ùå Error creando detalle:", detalleError);
                    throw detalleError;
                }
                console.log("‚úÖ Detalle creado exitosamente");

                showToast('¬°Incidencia creada y asignada exitosamente!');
                closeCreateIncidentModal();

                setTimeout(() => loadAssignmentPage(true), 1000);

            } catch (error) {
                console.error("üí• Error completo al crear la incidencia:", error);
                showToast(`Error al crear la incidencia: ${error.message}`, 'error');
            }
        }

        // --- RENDERING FUNCTIONS ---
        function renderStatistics(incidents, technicians, assignedIncidents = []) {
            const container = document.getElementById('stats-container');
            const inoperativos = incidents.filter(i => i.estado === 'Inoperativo').length;
            const pendientes = incidents.filter(i => i.estado === 'Pendiente').length;
            const totalPendientes = incidents.length;
            const totalTechnicians = technicians.length;
            const totalAsignadas = assignedIncidents.length;

            // Actualizar contadores en las pesta√±as
            document.getElementById('urgentes-count').textContent = inoperativos;
            document.getElementById('pendientes-count').textContent = pendientes;
            document.getElementById('asignadas-count').textContent = totalAsignadas;
            document.getElementById('tecnicos-count').textContent = totalTechnicians;

            const stats = [
                { title: 'Total Pendientes', value: totalPendientes, icon: 'list-todo', color: 'text-blue-600', bg: 'bg-blue-50' },
                { title: 'Inoperativos', value: inoperativos, icon: 'siren', color: 'text-red-600', bg: 'bg-red-50' },
                { title: 'Pendientes Normales', value: pendientes, icon: 'hourglass', color: 'text-amber-600', bg: 'bg-amber-50' },
                { title: 'T√©cnicos Disponibles', value: totalTechnicians, icon: 'wrench', color: 'text-green-600', bg: 'bg-green-50' },
                { title: 'Asignadas en Progreso', value: totalAsignadas, icon: 'user-check', color: 'text-indigo-600', bg: 'bg-indigo-50' }
            ];

            container.className = 'grid grid-cols-2 lg:grid-cols-3 xl:grid-cols-5 gap-6 mb-8 opacity-0 transition-opacity duration-500';

            container.innerHTML = stats.map(stat => `
                <div class="stats-card border-l-4 ${stat.color.replace('text-', 'border-')}">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-500 font-medium">${stat.title}</p>
                            <p class="text-3xl font-extrabold text-gray-900 mt-1">${stat.value}</p>
                        </div>
                        <div class="p-3 rounded-full ${stat.bg}">
                            <i data-lucide="${stat.icon}" class="w-7 h-7 ${stat.color}"></i>
                        </div>
                    </div>
                </div>
            `).join('');

            container.classList.remove('opacity-0');
            container.classList.add('opacity-100');
            lucide.createIcons();
        }

        function renderIncidents(incidents, technicians) {
            const inoperativos = incidents.filter(i => i.estado === 'Inoperativo');
            const pendientes = incidents.filter(i => i.estado === 'Pendiente');

            renderIncidentGroup(inoperativos, technicians, 'urgentes-container', 'inoperativo');
            renderIncidentGroup(pendientes, technicians, 'pendientes-container', 'pendiente');

            setupAssignmentListeners();
        }

        function renderTechniciansList(technicians) {
            const container = document.getElementById('tecnicos-container');

            if (technicians.length === 0) {
                container.innerHTML = `
                    <div class="empty-state bg-white p-8 rounded-lg text-center shadow-md col-span-full border-t-4 border-amber-400">
                        <i data-lucide="user-x" class="w-16 h-16 text-amber-500 mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">No se encontraron t√©cnicos</h3>
                        <p class="text-gray-500 mb-4">No hay t√©cnicos con cargo "Tecnico" o "Coordinador" registrados en el sistema.</p>
                        <p class="text-sm text-gray-400">(Si esto es un error, contacte al administrador)</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            const htmlContent = technicians.map(tech => {
                const isAvailable = tech.disponible !== false;
                return `
                <div class="technician-card bg-white p-4 rounded-lg shadow-md border-l-4 ${isAvailable ? 'border-green-500' : 'border-gray-400'}">
                    <div class="flex items-center gap-3 mb-3">
                        <div class="w-10 h-10 ${isAvailable ? 'bg-green-100' : 'bg-gray-100'} rounded-full flex items-center justify-center">
                            <i data-lucide="user" class="w-5 h-5 ${isAvailable ? 'text-green-600' : 'text-gray-500'}"></i>
                        </div>
                        <div>
                            <h3 class="font-semibold text-gray-800">${tech.usuario}</h3>
                            <p class="text-sm ${isAvailable ? 'text-green-600' : 'text-gray-500'}">${isAvailable ? 'Disponible' : 'No disponible'}</p>
                        </div>
                    </div>
                    <div class="flex items-center justify-between">
                        <div class="flex items-center gap-2">
                            <span class="status-dot ${isAvailable ? 'bg-green-500' : 'bg-gray-400'} w-3 h-3 rounded-full"></span>
                            <span class="text-sm ${isAvailable ? 'text-gray-600' : 'text-gray-400'}">${isAvailable ? 'Disponible' : 'No disponible'}</span>
                        </div>
                        <label class="availability-toggle">
                            <input type="checkbox" ${isAvailable ? 'checked' : ''} data-tech-id="${tech.id_usuario}">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            `}).join('');

            container.innerHTML = htmlContent;
            lucide.createIcons();

            // Configurar eventos de cambio de disponibilidad
            setupAvailabilityToggles();
        }

        function renderAssignedIncidents(assignedIncidents) {
            const container = document.getElementById('asignadas-container');
            if (!container) {
                console.error("No se encontr√≥ el contenedor 'asignadas-container'");
                return;
            }

            if (!assignedIncidents || assignedIncidents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state bg-white p-8 rounded-lg text-center shadow-md">
                        <i data-lucide="user-check" class="w-16 h-16 text-blue-400 mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">Sin asignaciones activas</h3>
                        <p class="text-gray-500">No hay incidencias con estado "En Progreso" o "Asignado".</p>
                        <div class="mt-4 p-3 bg-blue-50 rounded-lg border border-blue-200">
                            <p class="text-sm text-blue-700">
                                Cuando asignes una incidencia a un t√©cnico, aparecer√° aqu√≠ autom√°ticamente.
                            </p>
                        </div>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            const htmlContent = assignedIncidents.map((incident) => {
                const machine = incident.maquinas || {};
                const sala = machine.sala || {};
                const trabajo = incident.trabajos || {};
                const tecnico = incident.tecnicos || trabajo.tecnicos || {};
                const tipoReporte = tecnico.cargo || 'N/A';
                const esSala = tipoReporte.toLowerCase().includes('sala');
                const badgeColor = esSala ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';
                const badgeIcon = esSala ? 'building' : 'user';
                const reportadoPorHTML = `
                <span class="text-xs ${badgeColor} px-2 py-1 rounded-full flex items-center gap-1">
                    <i data-lucide="${badgeIcon}" class="w-3 h-3"></i>
                    Reportado por: ${tipoReporte}
                </span>
            `;

                const reportDate = incident.fecha_reporte || 'N/A';
                const reportTime = incident.hora_reporte || 'N/A';
                const assignmentDate = trabajo.fecha || 'N/A';
                const assignmentTime = trabajo.hora_inicio || 'N/A';

                const fechaReporte = reportDate !== 'N/A' ? new Date(reportDate + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }) : 'N/A';
                const horaReporte = reportTime.substring(0, 5);
                const fechaAsignacion = assignmentDate !== 'N/A' ? new Date(assignmentDate + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }) : 'N/A';
                const horaAsignacion = assignmentTime.substring(0, 5);

                const detallesHTML = incident.diag_ini || 'Sin detalles de diagn√≥stico.';

                return `
                    <div class="incident-card asignada">
                        <div class="incident-header" onclick="toggleIncidentDetails(this)">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 bg-blue-100 rounded-full flex items-center justify-center">
                                        <i data-lucide="laptop-minimal-check" class="w-5 h-5 text-blue-600"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-900">${sala.sala_mincetur || 'N/A'}</h3>
                                        <p class="text-sm text-gray-500">${machine.modelo || 'M√°quina Winsystems'} - S/N: ${machine.serie || 'N/A'}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-3">
                                    <span class="status-badge text-white bg-blue-600 flex items-center gap-1 py-1 px-3 rounded-full shadow-sm text-sm">
                                        <i data-lucide="user-check" class="w-4 h-4"></i> 
                                        ${incident.estado || 'Asignada'}
                                    </span>
                                    <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform"></i>
                                </div>
                            </div>
                        </div>
                        
                        <div class="incident-details hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="col-span-1">
                                    <p class="text-sm font-semibold text-gray-500 flex items-center gap-1">
                                        <i data-lucide="laptop-minimal-check" class="w-4 h-4 text-blue-600"></i> M√ÅQUINA
                                    </p>
                                    <h3 class="text-lg font-bold text-gray-900">${machine.modelo || 'M√°quina Winsystems'}</h3>
                                    <p class="text-xs text-gray-500">S/N: ${machine.serie || 'N/A'}</p>
                                    <p class="text-xs text-gray-400">ID Detalle: ${incident.id_detalle}</p>
                                </div>

                                <div class="col-span-1">
                                    <p class="text-sm font-semibold text-gray-500 flex items-center gap-1">
                                        <i data-lucide="map-pin" class="w-4 h-4"></i> UBICACI√ìN
                                    </p>
                                    <p class="text-md font-semibold text-gray-800">${sala.sala_mincetur || 'N/A'}</p>
                                    <p class="text-xs text-gray-500">${sala.distrito || ''}</p>
                                </div>

                                <div class="col-span-1 text-left md:text-right">
                                    <p class="text-xs text-gray-400 mt-1">Reportado: ${fechaReporte} ${horaReporte}</p>
                                    <p class="text-xs text-gray-400">Asignado: ${fechaAsignacion} ${horaAsignacion}</p>
                                    <div class="col-span-1 text-left md:text-right">
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <p class="text-xs text-gray-400 mt-1">Reportado: ${fechaReporte} ${horaReporte}</p>
                                        <p class="text-xs text-gray-400">Por: ${tecnico.usuario || 'N/A'}</p>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† <p class="text-xs text-gray-400">Asignado: ${fechaAsignacion} ${horaAsignacion}</p>
¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† ¬† </div>
                                </div>
                            </div>

                            <div class="border-t border-gray-100 pt-4 mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-1">
                                    <i data-lucide="file-text" class="w-4 h-4 text-gray-500"></i>
                                    Diagn√≥stico Inicial:
                                </p>
                                <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-100 report-details-box">
                                    ${detallesHTML}
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 mt-4 p-3 bg-green-50 rounded-lg border border-green-200">
                                <div class="flex items-center gap-3">
                                    <div class="w-8 h-8 bg-green-100 rounded-full flex items-center justify-center">
                                        <i data-lucide="user" class="w-4 h-4 text-green-600"></i>
                                    </div>
                                    <div>
                                        <p class="text-sm font-semibold text-gray-700">T√©cnico Asignado</p>
                                        <p class="text-lg font-bold text-green-600">${tecnico.usuario || 'Por asignar'}</p>
                                    </div>
                                </div>
                                <div class="flex items-center gap-2 text-sm text-gray-500">
                                    <i data-lucide="clock" class="w-4 h-4"></i>
                                    <span>${incident.estado || 'En progreso'}</span>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = htmlContent;
            lucide.createIcons();
        }

        function renderIncidentGroup(incidents, technicians, containerId, type) {
            const container = document.getElementById(containerId);
            const statusText = type === 'inoperativo' ? 'Inoperativo' : 'Pendiente';
            const urgencyIcon = type === 'inoperativo' ? 'bolt' : 'clock';
            const urgencyClass = type === 'inoperativo' ? 'attention-alert' : '';
            const machineIcon = 'laptop-minimal-check';

            if (incidents.length === 0) {
                container.innerHTML = `
                    <div class="empty-state bg-white p-8 rounded-lg text-center shadow-md">
                        <i data-lucide="sparkles" class="w-16 h-16 text-blue-400 mx-auto mb-4"></i>
                        <h3 class="text-xl font-semibold text-gray-700 mb-2">¬°Misi√≥n Cumplida!</h3>
                        <p class="text-gray-500">No hay incidencias ${type === 'inoperativo' ? 'urgentes' : 'pendientes'} en la cola de asignaci√≥n.</p>
                    </div>
                `;
                lucide.createIcons();
                return;
            }

            const htmlContent = incidents.map((incident) => {
                const reportDate = incident.fecha_reporte || incident.fecha || 'N/A';
                const reportTime = incident.hora_reporte || incident.hora || 'N/A';

                // Usamos la fecha/hora con formato para el tooltip
                const fecha = reportDate !== 'N/A' ? new Date(reportDate + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: 'numeric' }) : 'N/A';
                const hora = reportTime.substring(0, 5);

                // Usamos la fecha/hora sin formato para la funci√≥n timeAgo
                const elapsed = timeAgo(reportDate, reportTime);

                // Filtrar solo t√©cnicos disponibles
                const availableTechs = technicians.filter(tech => tech.disponible !== false);
                const selectOptions = availableTechs.map(tech =>
                    `<option value="${tech.id_usuario}">${tech.usuario}</option>`
                ).join('');

                const detallesConcatenados = [
                    incident.diag_ini ? ` ${incident.diag_ini}` : null,
                    incident.trab_realizado ? `${incident.trab_realizado}` : null,
                    incident.resul ? ` ${incident.resul}` : null
                ].filter(Boolean).join('<br>');

                const detallesHTML = detallesConcatenados || 'Sin detalles de diagn√≥stico o trabajo previo.';

                // Determinar tipo de reporte y estilos
                const tipoReporte = incident.cargo_reporta || 'N/A';
                const esSala = tipoReporte.toLowerCase().includes('sala');
                const badgeColor = esSala ? 'bg-purple-100 text-purple-800' : 'bg-blue-100 text-blue-800';
                const badgeIcon = esSala ? 'building' : 'users';

                return `
                    <div class="incident-card ${type} ${urgencyClass}">
                        <div class="incident-header" onclick="toggleIncidentDetails(this)">
                            <div class="flex items-center justify-between">
                                <div class="flex items-center gap-3">
                                    <div class="w-10 h-10 ${type === 'inoperativo' ? 'bg-red-100' : 'bg-amber-100'} rounded-full flex items-center justify-center">
                                        <i data-lucide="${machineIcon}" class="w-5 h-5 ${type === 'inoperativo' ? 'text-red-600' : 'text-amber-600'}"></i>
                                    </div>
                                    <div>
                                        <h3 class="font-bold text-gray-900">${incident.sala_mincetur || 'N/A'}</h3>
                                        <p class="text-sm text-gray-500">${incident.modelo || 'M√°quina Winsystems'} - S/N: ${incident.serie || 'N/A'}</p>
                                        <div class="flex items-center gap-2 mt-1">
                                            <span class="text-xs ${badgeColor} px-2 py-1 rounded-full flex items-center gap-1">
                                                <i data-lucide="${badgeIcon}" class="w-3 h-3"></i>
                                                Reportado por: ${tipoReporte}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="flex items-center gap-3">
                                    <div class="flex flex-col items-end gap-1 text-right">
                                        <span class="text-xs font-semibold text-gray-500 flex items-center gap-1" title="Reportado: ${fecha} ${hora}">
                                            <i data-lucide="calendar-clock" class="w-3 h-3"></i>
                                            ${elapsed}
                                        </span>
                                        <span class="status-badge text-white ${type === 'inoperativo' ? 'bg-red-600' : 'bg-amber-600'} flex items-center gap-1 py-1 px-2 rounded-full shadow-sm text-xs">
                                            <i data-lucide="${urgencyIcon}" class="w-3 h-3"></i> 
                                            ${statusText}
                                        </span>
                                    </div>
                                    <i data-lucide="chevron-down" class="w-5 h-5 text-gray-400 transition-transform"></i>
                                </div>

                            </div>
                        </div>
                        
                        <div class="incident-details hidden">
                            <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                                <div class="col-span-1">
                                    <p class="text-sm font-semibold text-gray-500 flex items-center gap-1">
                                        <i data-lucide="${machineIcon}" class="w-4 h-4 text-blue-600"></i> M√ÅQUINA
                                    </p>
                                    <h3 class="text-lg font-bold text-gray-900">${incident.modelo || 'M√°quina Winsystems'}</h3>
                                    <p class="text-xs text-gray-500">S/N: ${incident.serie || 'N/A'}</p>
                                </div>

                                <div class="col-span-1">
                                    <p class="text-sm font-semibold text-gray-500 flex items-center gap-1">
                                        <i data-lucide="map-pin" class="w-4 h-4"></i> UBICACI√ìN
                                    </p>
                                    <p class="text-md font-semibold text-gray-800">${incident.sala_mincetur || 'N/A'}</p>
                                    <p class="text-xs text-gray-500">${incident.distrito || ''}</p>
                                </div>

                                <div class="col-span-1 text-left md:text-right">
                                    <p class="text-xs text-gray-400 mt-1">Reportado: ${fecha} ${hora}</p>
                                    ${incident.tecnico_reporta ? `<p class="text-xs text-gray-400">Por: ${incident.tecnico_reporta} (${tipoReporte})</p>` : ''}
                                </div>
                            </div>

                            <div class="border-t border-gray-100 pt-4 mb-4">
                                <p class="text-sm font-medium text-gray-700 mb-2 flex items-center gap-1">
                                    <i data-lucide="file-text" class="w-4 h-4 text-gray-500"></i>
                                    Historial del Reporte:
                                </p>
                                <div class="text-sm text-gray-600 bg-gray-50 p-3 rounded-lg border border-gray-100 report-details-box whitespace-pre-wrap text-justify">
                                    ${detallesHTML}
                                </div>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3 mt-4 p-3 bg-blue-50/50 rounded-lg border border-blue-100">
                                <select class="technician-select flex-grow text-sm" data-incident-id="${incident.id_maquina}">
                                    <option value="" disabled selected>Selecciona un T√©cnico para asignar...</option>
                                    ${selectOptions}
                                </select>
                                <button 
                                    data-incident='${JSON.stringify(incident)}' 
                                    class="assign-button w-full sm:w-auto flex items-center justify-center gap-2 bg-blue-600 hover:bg-blue-700 disabled:opacity-50 text-white font-semibold shadow-md transition-colors"
                                    disabled
                                >
                                    <i data-lucide="send" class="w-4 h-4"></i>
                                    Asignar
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');

            container.innerHTML = htmlContent;
            lucide.createIcons();
        }

        // --- TOGGLE INCIDENT DETAILS ---
        function toggleIncidentDetails(element) {
            const card = element.closest('.incident-card');
            const details = card.querySelector('.incident-details');
            const icon = element.querySelector('i[data-lucide="chevron-down"]');

            if (details.classList.contains('hidden')) {
                details.classList.remove('hidden');
                icon.style.transform = 'rotate(180deg)';
            } else {
                details.classList.add('hidden');
                icon.style.transform = 'rotate(0deg)';
            }
        }

        // --- EXPAND ALL FUNCTIONALITY ---
        function setupExpandAllButtons() {
            // Urgentes
            document.getElementById('expand-all-urgentes').addEventListener('click', function () {
                const container = document.getElementById('urgentes-container');
                const isExpanded = this.getAttribute('data-expanded') === 'true';

                if (isExpanded) {
                    container.querySelectorAll('.incident-details').forEach(detail => {
                        detail.classList.add('hidden');
                    });
                    container.querySelectorAll('i[data-lucide="chevron-down"]').forEach(icon => {
                        icon.style.transform = 'rotate(0deg)';
                    });
                    this.setAttribute('data-expanded', 'false');
                    this.innerHTML = '<i data-lucide="chevrons-down" class="w-4 h-4"></i> Expandir Todo';
                } else {
                    container.querySelectorAll('.incident-details').forEach(detail => {
                        detail.classList.remove('hidden');
                    });
                    container.querySelectorAll('i[data-lucide="chevron-down"]').forEach(icon => {
                        icon.style.transform = 'rotate(180deg)';
                    });
                    this.setAttribute('data-expanded', 'true');
                    this.innerHTML = '<i data-lucide="chevrons-up" class="w-4 h-4"></i> Contraer Todo';
                }
                lucide.createIcons();
            });

            // Pendientes
            document.getElementById('expand-all-pendientes').addEventListener('click', function () {
                const container = document.getElementById('pendientes-container');
                const isExpanded = this.getAttribute('data-expanded') === 'true';

                if (isExpanded) {
                    container.querySelectorAll('.incident-details').forEach(detail => {
                        detail.classList.add('hidden');
                    });
                    container.querySelectorAll('i[data-lucide="chevron-down"]').forEach(icon => {
                        icon.style.transform = 'rotate(0deg)';
                    });
                    this.setAttribute('data-expanded', 'false');
                    this.innerHTML = '<i data-lucide="chevrons-down" class="w-4 h-4"></i> Expandir Todo';
                } else {
                    container.querySelectorAll('.incident-details').forEach(detail => {
                        detail.classList.remove('hidden');
                    });
                    container.querySelectorAll('i[data-lucide="chevron-down"]').forEach(icon => {
                        icon.style.transform = 'rotate(180deg)';
                    });
                    this.setAttribute('data-expanded', 'true');
                    this.innerHTML = '<i data-lucide="chevrons-up" class="w-4 h-4"></i> Contraer Todo';
                }
                lucide.createIcons();
            });

            // Asignadas
            document.getElementById('expand-all-asignadas').addEventListener('click', function () {
                const container = document.getElementById('asignadas-container');
                const isExpanded = this.getAttribute('data-expanded') === 'true';

                if (isExpanded) {
                    container.querySelectorAll('.incident-details').forEach(detail => {
                        detail.classList.add('hidden');
                    });
                    container.querySelectorAll('i[data-lucide="chevron-down"]').forEach(icon => {
                        icon.style.transform = 'rotate(0deg)';
                    });
                    this.setAttribute('data-expanded', 'false');
                    this.innerHTML = '<i data-lucide="chevrons-down" class="w-4 h-4"></i> Expandir Todo';
                } else {
                    container.querySelectorAll('.incident-details').forEach(detail => {
                        detail.classList.remove('hidden');
                    });
                    container.querySelectorAll('i[data-lucide="chevron-down"]').forEach(icon => {
                        icon.style.transform = 'rotate(180deg)';
                    });
                    this.setAttribute('data-expanded', 'true');
                    this.innerHTML = '<i data-lucide="chevrons-up" class="w-4 h-4"></i> Contraer Todo';
                }
                lucide.createIcons();
            });
        }

        function setupAssignmentListeners() {
            document.querySelectorAll('.incident-card').forEach(card => {
                const select = card.querySelector('.technician-select');
                const button = card.querySelector('.assign-button');

                if (select && button) {
                    select.addEventListener('change', () => {
                        button.disabled = !select.value;
                    });

                    button.addEventListener('click', async () => {
                        const incidentData = JSON.parse(button.dataset.incident);
                        const technicianId = select.value;

                        if (!technicianId) {
                            showToast('Por favor, selecciona un t√©cnico.', 'error');
                            return;
                        }

                        button.disabled = true;
                        button.innerHTML = '<i data-lucide="loader-2" class="w-4 h-4 animate-spin"></i> Asignando...';
                        lucide.createIcons();

                        await handleAssignment(incidentData, technicianId, card);
                    });
                }
            });
        }

        // --- AVAILABILITY TOGGLES ---
        function setupAvailabilityToggles() {
            document.querySelectorAll('.availability-toggle input').forEach(toggle => {
                toggle.addEventListener('change', async function () {
                    const techId = this.getAttribute('data-tech-id');
                    const isAvailable = this.checked;

                    try {
                        const { error } = await supabaseClient
                            .from('tecnicos')
                            .update({ disponible: isAvailable })
                            .eq('id_usuario', techId);

                        if (error) throw error;

                        showToast(`T√©cnico ${isAvailable ? 'marcado como disponible' : 'marcado como no disponible'}`);

                        // Actualizar la lista de t√©cnicos
                        setTimeout(() => loadAssignmentPage(true), 500);
                    } catch (error) {
                        console.error("Error al actualizar disponibilidad:", error);
                        showToast('Error al actualizar disponibilidad', 'error');
                        this.checked = !isAvailable; // Revertir el cambio
                    }
                });
            });
        }

        // --- ASSIGNMENT HANDLING ---
        async function handleAssignment(incident, technicianId, cardElement) {
            const { fecha, hora } = getPeruDateTime();

            try {
                // 1. Create trabajo record
                const { data: newTrabajo, error: trabajoError } = await supabaseClient
                    .from('trabajos')
                    .insert({
                        id_sala: incident.id_sala,
                        id_usuario: technicianId,
                        fecha: fecha,
                        hora_inicio: hora,
                        hora_fin: hora
                    })
                    .select()
                    .single();

                if (trabajoError) throw trabajoError;

                // 2. Create detalle record
                const { error: detalleError } = await supabaseClient
                    .from('detalle')
                    .insert({
                        id_trabajo: newTrabajo.id_trabajo,
                        id_maquina: incident.id_maquina,
                        diag_ini: `Asignado por coordinador. Reporte original: ${incident.diag_ini || 'Sin descripci√≥n inicial.'}. Trabajos previos: ${incident.trab_realizado || 'N/A'}. Resultado anterior: ${incident.resul || 'N/A'}.`,
                        estado: 'En Progreso',
                        tipo_trabajo: incident.tipo_trabajo,
                    });

                if (detalleError) throw detalleError;

                showToast(`¬°Tarea ${incident.serie} asignada con √©xito!`);

                cardElement.style.opacity = '0';
                cardElement.style.transform = 'translateY(-20px) scale(0.95)';
                setTimeout(() => {
                    cardElement.remove();
                    loadAssignmentPage(true);
                }, 300);

            } catch (error) {
                console.error("Error al asignar la tarea:", error);
                showToast(`Error al asignar: ${error.message}`, 'error');

                const button = cardElement.querySelector('.assign-button');
                button.disabled = false;
                button.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> Asignar';
                lucide.createIcons();
            }
        }

        // --- SEARCH & SORT FUNCTIONS ---
        function setupSearchFilters() {
            const addFilter = (inputId, containerId, cardSelector) => {
                const input = document.getElementById(inputId);
                if (!input) return;

                input.addEventListener('input', (e) => {
                    const searchTerm = e.target.value.toLowerCase().trim();
                    const cards = document.querySelectorAll(`#${containerId} ${cardSelector}`);

                    cards.forEach(card => {
                        const cardText = card.textContent.toLowerCase();
                        if (cardText.includes(searchTerm)) {
                            card.style.display = 'block';
                        } else {
                            card.style.display = 'none';
                        }
                    });
                });
            };

            addFilter('search-urgentes', 'urgentes-container', '.incident-card');
            addFilter('search-pendientes', 'pendientes-container', '.incident-card');
            addFilter('search-asignadas', 'asignadas-container', '.incident-card');
            addFilter('search-tecnicos', 'tecnicos-container', '.technician-card');
        }

        function setupTechnicianSort() {
            const sortBtn = document.getElementById('sort-tecnicos');
            if (!sortBtn) return;

            sortBtn.setAttribute('data-sort-mode', 'name-asc'); // Initial state
            sortBtn.innerHTML = '<i data-lucide="arrow-up-a-z" class="w-4 h-4"></i> Nombre (A-Z)';
            lucide.createIcons();

            sortBtn.addEventListener('click', function () {
                const container = document.getElementById('tecnicos-container');
                const cards = Array.from(container.querySelectorAll('.technician-card'));
                const currentMode = this.getAttribute('data-sort-mode');
                let nextMode = 'name-asc';

                cards.sort((a, b) => {
                    const nameA = a.querySelector('h3').textContent.trim();
                    const nameB = b.querySelector('h3').textContent.trim();
                    const availableA = a.querySelector('.availability-toggle input').checked;
                    const availableB = b.querySelector('.availability-toggle input').checked;

                    if (currentMode === 'name-asc') {
                        nextMode = 'name-desc';
                        this.innerHTML = '<i data-lucide="arrow-down-z-a" class="w-4 h-4"></i> Nombre (Z-A)';
                        return nameB.localeCompare(nameA);
                    } else if (currentMode === 'name-desc') {
                        nextMode = 'available';
                        this.innerHTML = '<i data-lucide="user-check" class="w-4 h-4"></i> Disponibles';
                        if (availableA && !availableB) return -1;
                        if (!availableA && availableB) return 1;
                        return nameA.localeCompare(nameB); // Fallback to name
                    } else { // currentMode === 'available'
                        nextMode = 'name-asc';
                        this.innerHTML = '<i data-lucide="arrow-up-a-z" class="w-4 h-4"></i> Nombre (A-Z)';
                        return nameA.localeCompare(nameB);
                    }
                });

                cards.forEach(card => container.appendChild(card));
                this.setAttribute('data-sort-mode', nextMode);
                lucide.createIcons();
            });
        }

        // --- STARTUP ---
        document.addEventListener('DOMContentLoaded', () => {
            lucide.createIcons();

            // Configurar eventos del modal
            document.getElementById('create-incident-btn').addEventListener('click', openCreateIncidentModal);
            document.getElementById('close-modal').addEventListener('click', closeCreateIncidentModal);
            document.getElementById('cancel-create').addEventListener('click', closeCreateIncidentModal);

            // Configurar env√≠o del formulario
            document.getElementById('create-incident-form').addEventListener('submit', function (e) {
                e.preventDefault();

                const formData = {
                    sala: document.getElementById('sala').value,
                    serie: document.getElementById('serie').value,
                    tecnico: document.getElementById('tecnico').value,
                    diagnostico: document.getElementById('diagnostico').value
                };

                createNewIncident(formData);
            });

            // Configurar eventos de pesta√±as
            document.querySelectorAll('.tab-button').forEach(button => {
                button.addEventListener('click', function () {
                    const tabName = this.getAttribute('data-tab');
                    switchTab(tabName);
                });
            });

            // 1. Inicia el proceso de autenticaci√≥n y carga
            checkCoordinatorSession();

            // 2. Configura la escucha en tiempo real
            setupRealtimeSubscription((isRealtime) => {
                setTimeout(() => loadAssignmentPage(isRealtime), 500);
            });

            // 3. Configura los botones de expandir todo
            setupExpandAllButtons();

            // 4. NUEVO: Configura filtros de b√∫squeda
            setupSearchFilters();

            // 5. NUEVO: Configura el bot√≥n de ordenar t√©cnicos
            setupTechnicianSort();

            // 6. Auto-refresh de respaldo (MODIFICADO a 'true' para ser suave)
            setInterval(() => {
                loadAssignmentPage(true); // 'true' evita mostrar el loading overlay
            }, 30000);
        });
    </script>
</body>

</html>
