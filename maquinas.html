<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard de Métricas - Winsystems</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

        :root {
            --ws-primary: #1e40af;
            --ws-secondary: #3b82f6;
            --ws-accent: #f97316;
            --ws-light: #f0f7ff;
            --ws-dark: #1e293b;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f7ff 0%, #e0f2fe 100%);
            min-height: 100vh;
        }

        .stats-card {
            transition: all 0.3s ease;
            border-left: 4px solid;
            background: white;
            position: relative;
            overflow: hidden;
        }

        .stats-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--ws-primary), var(--ws-accent));
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .stats-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }

        .stats-card:hover::before {
            transform: scaleX(1);
        }

        .chart-container {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
            transition: all 0.3s ease;
        }

        .chart-container:hover {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }

        .filter-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid #e5e7eb;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 8px;
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading-dots::after {
            content: '';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--ws-primary), var(--ws-secondary));
            color: white;
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.4);
        }

        .icon-container {
            transition: all 0.3s ease;
        }

        .stats-card:hover .icon-container {
            transform: scale(1.1);
        }

        /* Modal specific styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 100; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.5); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 24px;
            border-radius: 12px;
            width: 90%;
            max-width: 800px;
            box-shadow: 0 10px 20px rgba(0,0,0,0.19), 0 6px 6px rgba(0,0,0,0.23);
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateY(-50px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }

        .close-button:hover,
        .close-button:focus {
            color: #000;
            text-decoration: none;
            cursor: pointer;
        }

        /* Tooltip style */
        [title] {
            cursor: help;
        }
    </style>
</head>

<body class="text-gray-800">

    <div id="loading-overlay" class="fixed inset-0 bg-white z-50 flex flex-col items-center justify-center">
        <div class="text-center">
            <div class="relative mb-6">
                <div class="w-16 h-16 border-4 border-blue-200 border-t-blue-600 rounded-full animate-spin mx-auto"></div>
                <i data-lucide="bar-chart-3" class="w-8 h-8 text-blue-600 absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2"></i>
            </div>
            <h3 class="text-xl font-semibold text-gray-800 mb-2">Cargando Métricas</h3>
            <p class="text-gray-600">Calculando últimos estados<span class="loading-dots"></span></p>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 max-w-7xl opacity-0" id="main-content">
        <header class="mb-8 bg-white rounded-2xl p-6 shadow-sm border border-gray-100">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4">
                <div class="flex items-center gap-4">
                    <div class="bg-gradient-to-br from-ws-primary to-ws-secondary p-3 rounded-2xl shadow-sm">
                        <i data-lucide="bar-chart-3" class="w-8 h-8 text-white"></i>
                    </div>
                    <div>
                        <h1 id="main-title" class="text-2xl md:text-3xl font-bold text-gray-900">Dashboard de Métricas</h1>
                        <p id="main-subtitle" class="text-gray-600 mt-1">Último estado por máquina - Análisis actualizado</p>
                    </div>
                </div>
                <div class="flex items-center gap-3">
                    <button id="reset-view-btn" class="hidden bg-gray-100 text-gray-700 px-4 py-2 rounded-lg hover:bg-gray-200 transition-all duration-300 flex items-center gap-2">
                        <i data-lucide="refresh-ccw" class="w-4 h-4"></i>
                        Vista General
                    </button>
                    <a href="./home.html" class="bg-ws-primary text-white px-4 py-2 rounded-lg hover:bg-ws-secondary transition-all duration-300 flex items-center gap-2 group">
                        <i data-lucide="arrow-left" class="w-4 h-4 group-hover:-translate-x-1 transition-transform"></i>
                        Volver al Inicio
                    </a>
                </div>
            </div>
        </header>

        <div class="filter-section p-6 mb-8">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <div>
                    <label for="start-date" class="block text-sm font-medium text-gray-700 mb-2">
                        <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                        Fecha Inicio
                    </label>
                    <input type="date" id="start-date" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-ws-primary focus:ring-ws-primary/20 transition-colors">
                </div>
                <div>
                    <label for="end-date" class="block text-sm font-medium text-gray-700 mb-2">
                        <i data-lucide="calendar" class="w-4 h-4 inline mr-1"></i>
                        Fecha Fin
                    </label>
                    <input type="date" id="end-date" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-ws-primary focus:ring-ws-primary/20 transition-colors">
                </div>
                <div id="gabinete-filter-container">
                    <label for="type-filter" class="block text-sm font-medium text-gray-700 mb-2">
                        <i data-lucide="filter" class="w-4 h-4 inline mr-1"></i>
                        Tipo de Gabinete
                    </label>
                    <select id="type-filter" class="w-full rounded-lg border-gray-300 shadow-sm focus:border-ws-primary focus:ring-ws-primary/20 transition-colors">
                        <option>Todos</option>
                    </select>
                </div>
                <button id="apply-filters" class="btn-primary px-6 py-3 rounded-lg font-semibold flex items-center justify-center gap-2 h-[42px]">
                    <i data-lucide="sliders" class="w-4 h-4"></i>
                    Aplicar Filtros
                </button>
            </div>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-5 gap-6 mb-8">
            <div class="stats-card p-6 rounded-xl fade-in" data-status="Total">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Total Máquinas</p>
                        <p id="total-maquinas" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="icon-container bg-blue-100 p-3 rounded-full">
                        <i data-lucide="server" class="w-6 h-6 text-blue-600"></i>
                    </div>
                </div>
                <div class="mt-3 flex items-center text-xs text-gray-500">
                    <i data-lucide="cpu" class="w-4 h-4 mr-1 text-blue-500"></i>
                    <span>Máquinas únicas atendidas</span>
                </div>
            </div>

            <div class="stats-card p-6 rounded-xl fade-in" data-status="Operativo">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Operativas</p>
                        <p id="total-operativas" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="icon-container bg-green-100 p-3 rounded-full">
                        <i data-lucide="check-circle" class="w-6 h-6 text-green-600"></i>
                    </div>
                </div>
                <div class="mt-3 flex items-center text-xs text-gray-500">
                    <span class="status-indicator bg-green-500"></span>
                    <span>Último estado: Operativo</span>
                </div>
            </div>

            <div class="stats-card p-6 rounded-xl fade-in" data-status="Inoperativo">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Inoperativas</p>
                        <p id="total-inoperativas" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="icon-container bg-red-100 p-3 rounded-full">
                        <i data-lucide="alert-triangle" class="w-6 h-6 text-red-600"></i>
                    </div>
                </div>
                <div class="mt-3 flex items-center text-xs text-gray-500">
                    <span class="status-indicator bg-red-500"></span>
                    <span>Último estado: Inoperativo</span>
                </div>
            </div>

            <div class="stats-card p-6 rounded-xl fade-in" data-status="Pendiente">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Pendientes</p>
                        <p id="total-pendientes" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="icon-container bg-yellow-100 p-3 rounded-full">
                        <i data-lucide="clock" class="w-6 h-6 text-yellow-600"></i>
                    </div>
                </div>
                <div class="mt-3 flex items-center text-xs text-gray-500">
                    <span class="status-indicator bg-yellow-500"></span>
                    <span>Último estado: Pendiente</span>
                </div>
            </div>

            <div id="card-sin-estado" data-status="Sin Estado" 
                 class="stats-card p-6 rounded-xl fade-in cursor-pointer group">
                <div class="flex items-center justify-between">
                    <div>
                        <p class="text-gray-500 text-sm font-medium">Sin Estado</p>
                        <p id="total-sin-estado" class="text-2xl font-bold text-gray-800 mt-1">0</p>
                    </div>
                    <div class="icon-container bg-gray-100 p-3 rounded-full group-hover:bg-gray-200 transition-colors">
                        <i data-lucide="help-circle" class="w-6 h-6 text-gray-600"></i>
                    </div>
                </div>
                <div class="mt-3 flex items-center text-xs text-gray-500">
                    <span class="status-indicator bg-gray-400"></span>
                    <span>Estado no definido</span>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
            <div class="lg:col-span-2 chart-container p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="top-salas-title" class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                        <i data-lucide="building" class="w-5 h-5 text-ws-primary"></i>
                        Top 15 Salas Más Visitadas
                    </h2>
                    <div class="text-sm text-gray-500 flex items-center gap-1">
                        <i data-lucide="mouse-pointer" class="w-4 h-4"></i>
                        <span>Haz clic para filtrar</span>
                    </div>
                </div>
                <div class="h-96">
                    <canvas id="topSalasChart"></canvas>
                </div>
            </div>

            <div class="chart-container p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="top-trabajos-title" class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                        <i data-lucide="pie-chart" class="w-5 h-5 text-ws-primary"></i>
                        Distribución por Estado
                    </h2>
                    <div class="text-sm text-gray-500 flex items-center gap-1">
                        <i data-lucide="check-square" class="w-4 h-4"></i>
                        <span>Último estado por máquina</span>
                    </div>
                </div>
                <div class="h-96">
                    <canvas id="estadosChart"></canvas>
                </div>
            </div>
            
            <div class="lg:col-span-2 chart-container p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="top-repuestos-title" class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                        <i data-lucide="wrench" class="w-5 h-5 text-ws-accent"></i>
                        Top 15 Repuestos Cambiados
                    </h2>
                    <div class="text-sm text-gray-500 flex items-center gap-1">
                        <i data-lucide="mouse-pointer" class="w-4 h-4"></i>
                        <span>Haz clic para ver detalles</span>
                    </div>
                </div>
                <div class="h-96">
                    <canvas id="topRepuestosChart"></canvas>
                </div>
                <div class="text-right mt-4">
                    <button id="show-all-repuestos-btn" class="inline-flex items-center px-4 py-2 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition-colors">
                        <i data-lucide="list-plus" class="w-4 h-4 mr-2"></i>
                        Ver todos los repuestos...
                    </button>
                </div>
            </div>
            
        </div>

        <div id="sala-details-container" class="hidden">
            <div class="chart-container p-6">
                <div class="flex items-center justify-between mb-6">
                    <h2 id="sala-details-title" class="text-xl font-semibold text-gray-800 flex items-center gap-2">
                        <i data-lucide="list" class="w-5 h-5 text-ws-primary"></i>
                        Detalles del Reporte
                    </h2>
                    <button onclick="document.getElementById('sala-details-container').classList.add('hidden')" 
                            class="text-gray-500 hover:text-gray-700 transition-colors">
                        <i data-lucide="x" class="w-5 h-5"></i>
                    </button>
                </div>
                <div id="sala-details-table" class="overflow-x-auto"></div>
            </div>
        </div>

        
    </div>

    <div id="repuestos-modal" class="modal">
        <div class="modal-content">
            <span class="close-button" id="close-repuestos-modal">&times;</span>
            <div class="flex items-center gap-3 mb-6">
                <div class="bg-orange-100 p-2 rounded-full">
                    <i data-lucide="box" class="w-6 h-6 text-orange-600"></i>
                </div>
                <h2 class="text-2xl font-bold text-gray-800">Repuestos Cambiados (Histórico)</h2>
            </div>
            <p id="repuestos-modal-summary" class="text-gray-600 mb-6 border-b pb-4"></p>
            <div id="repuestos-modal-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-96 overflow-y-auto pr-2">
                </div>
            <div class="mt-8 text-center text-sm text-gray-500">
                <p>Este listado incluye todos los repuestos detectados en los reportes de "trabajos realizados" dentro del rango de fechas seleccionado.</p>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIG & GLOBAL VARS ---
        const SUPABASE_URL = 'https://qobquktxvhlvtrpeopji.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvYnF1a3R4dmhsdnRycGVvcGppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU2OTc4NDYsImV4cCI6MjA2MTI3Mzg0Nn0.rnubNUWSWEomj5Xwvr65kZLK7Ig_bLC74ajFh9cksFc';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let topSalasChartInstance, estadosChartInstance;
        let topRepuestosChartInstance; 
        let selectedSalas = [];
        let allReportDetails = []; // Guarda los resultados de getLastStateBySerie
        let rawMachineStatesData = []; // Guarda TODOS los datos de fetchMachineStates
        let lastStatesBySerie = new Map();
        let currentAllRepuestos = [];

        // --- LÓGICA DE AYUDA ---
        function getGabineteTypeBySerie(serie) {
            if (!serie) return 'Desconocido';
            const len = String(serie).trim().length;
            if (len === 4) return 'Ruleta';
            if (len === 5) return 'Slot';
            if (len === 6) return 'Pc-Controller';
            return 'Otro';
        }

        // --- FUNCIÓN CLAVE: Obtener último estado por serie ---
        function getLastStateBySerie(data) {
            const seriesMap = new Map();
            console.log('--- getLastStateBySerie: Recibiendo datos para ordenar ---', data);

            const sortedData = [...data].sort((a, b) => {
                try {
                    const dateA = a && a.trabajos ? a.trabajos.fecha : null;
                    const dateB = b && b.trabajos ? b.trabajos.fecha : null;
                    if (!dateB) return -1;
                    if (!dateA) return 1;
                    return new Date(dateB) - new Date(dateA);
                } catch (e) {
                    console.error('--- ERROR EN SORT de getLastStateBySerie ---', e, a, b);
                    return 0; 
                }
            });

            sortedData.forEach(item => {
                if (item && item.maquinas && item.maquinas.serie) {
                    const serie = item.maquinas.serie;
                    if (!seriesMap.has(serie)) {
                        seriesMap.set(serie, item);
                    }
                } else {
                    console.warn('Item sin .maquinas.serie encontrado:', item);
                }
            });

            return Array.from(seriesMap.values());
        }

        // --- SESIÓN E INICIALIZACIÓN ---
        async function checkSession() {
            const { data: { session } } = await supabaseClient.auth.getSession();
            if (!session) { window.location.href = './index.html'; return; }
            initializePage();
        }

        async function initializePage() {
            document.getElementById('apply-filters').addEventListener('click', applyFilters);
            document.getElementById('reset-view-btn').addEventListener('click', () => {
                applyFilters();
                document.getElementById('sala-details-container').classList.add('hidden');
            });
            document.getElementById('show-all-repuestos-btn').addEventListener('click', showAllRepuestosModal);
            document.getElementById('close-repuestos-modal').addEventListener('click', () => document.getElementById('repuestos-modal').style.display = 'none');
            window.addEventListener('click', (event) => {
                if (event.target == document.getElementById('repuestos-modal')) {
                    document.getElementById('repuestos-modal').style.display = 'none';
                }
            });

            setDefaultDates();
            populateGabineteFilter();
            await applyFilters();
            document.getElementById('main-content').classList.remove('opacity-0');
            document.getElementById('loading-overlay').style.display = 'none';
            addCardClickListeners();
            lucide.createIcons();
        }

        // --- FILTROS Y BÚSQUEDA PRINCIPAL ---
        function setDefaultDates() {
            const endDateInput = document.getElementById('end-date');
            const startDateInput = document.getElementById('start-date');
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            endDateInput.value = today.toISOString().split('T')[0];
            startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        }

        function populateGabineteFilter() {
            const typeFilterInput = document.getElementById('type-filter');
            typeFilterInput.innerHTML = '<option>Todos</option>';
            const customGabinetes = ['Ruleta', 'Slot', 'Pc-Controller'];
            customGabinetes.forEach(g => {
                const option = document.createElement('option');
                option.value = g;
                option.textContent = g;
                typeFilterInput.appendChild(option);
            });
        }

        async function applyFilters() {
            document.getElementById('loading-overlay').style.display = 'flex';
            selectedSalas = [];
            updateTitles();

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const typeFilter = document.getElementById('type-filter').value;

            try {
                // Fetch all data
                const fetchedMachineStates = await fetchMachineStates(startDate, endDate, typeFilter);
                rawMachineStatesData = fetchedMachineStates; // Store raw data

                const topSalasData = await fetchTopSalas(startDate, endDate, typeFilter);
                
                console.log('--- applyFilters: Datos crudos de fetchMachineStates ---');
                console.log(rawMachineStatesData);
                
                const allRepuestos = analyzeRepuestos(rawMachineStatesData); // Analyze raw data
                currentAllRepuestos = allRepuestos;
                const topRepuestosData = [...allRepuestos].sort((a,b) => b.cantidad - a.cantidad).slice(0, 15);
                
                const lastStatesData = getLastStateBySerie(rawMachineStatesData); // Process for last states
                allReportDetails = lastStatesData; // Update global for card clicks
                lastStatesBySerie = new Map(lastStatesData.map(item => [item.maquinas.serie, item]));
                
                updateMachineStatesUI(lastStatesData);
                updateTopSalasUI(topSalasData);
                updateEstadosChart(lastStatesData);
                updateTopRepuestosUI(topRepuestosData); 
                document.getElementById('sala-details-container').classList.add('hidden'); // Hide details on filter apply
            } catch (error) {
                console.error("Error al aplicar filtros:", error);
            } finally {
                document.getElementById('loading-overlay').style.display = 'none';
            }
        }

        // --- FUNCIONES DE BÚSQUEDA DE DATOS ---
        async function fetchMachineStates(startDate, endDate, typeFilter, salaNames = []) {
            
            // --- INICIO DE CORRECCIÓN (Columnas en 'detalle' + Bug de Supabase + diag_ini) ---
            let query = supabaseClient.from('detalle')
                .select(`
                    estado, 
                    tipo_trabajo,
                    trab_realizado, 
                    resul,
                    diag_ini, 
                    maquinas!inner(id_maquina, serie), 
                    trabajos(
                        id_trabajo, 
                        fecha, 
                        sala!inner(sala_mincetur), 
                        tecnicos(usuario)
                    )
                `) 
            // --- FIN DE CORRECCIÓN ---
                .gte('trabajos.fecha', startDate)
                .lte('trabajos.fecha', endDate)
                .order('fecha', { foreignTable: 'trabajos' });

            if (salaNames.length > 0) {
                 query = query.in('trabajos.sala.sala_mincetur', salaNames);
            }

            const { data, error } = await query.limit(10000);

            if (error) {
                console.error("Error fetching machine states:", error);
                return [];
            }

            const filteredData = data.filter(item => item.trabajos);
            
            if (typeFilter && typeFilter !== 'Todos') {
                return filteredData.filter(item => getGabineteTypeBySerie(item.maquinas.serie) === typeFilter);
            }

            return filteredData;
        }

        async function fetchTopSalas(startDate, endDate, typeFilter) {
            let query = supabaseClient.from('trabajos')
                .select('sala(sala_mincetur), detalle!inner(maquinas!inner(serie))')
                .gte('fecha', startDate)
                .lte('fecha', endDate);

            const { data, error } = await query.limit(10000);
            
            if (error) { 
                console.error("Error fetching top salas:", error); 
                return []; 
            }
            
            let filteredData = data;
            if (typeFilter && typeFilter !== 'Todos') {
                filteredData = data.filter(t => 
                    t.detalle.some(d => getGabineteTypeBySerie(d.maquinas.serie) === typeFilter)
                );
            }
            
            const salaVisits = filteredData.reduce((acc, t) => {
                if (t.sala && t.sala.sala_mincetur) { 
                    acc[t.sala.sala_mincetur] = (acc[t.sala.sala_mincetur] || 0) + 1; 
                }
                return acc;
            }, {});
            
            return Object.entries(salaVisits)
                .map(([nombre_sala, visitas]) => ({ nombre_sala, visitas }))
                .sort((a, b) => b.visitas - a.visitas)
                .slice(0, 15);
        }

        // --- FUNCIÓN MODIFICADA: Analizar repuestos (con sinónimos) ---
        function analyzeRepuestos(data) {
            console.log('--- analyzeRepuestos: Recibiendo datos para analizar ---', data);
            
            const repuestos_map = {
                'Pantalla/Monitor': /\b(monitor|pantalla)\b/i,
                'RAM/Memoria': /\b(ram|memoria)\b/i,
                'Touchscreen': /\b(touchscreen|tactil)\b/i,
                'Disco Duro/SSD': /\b(disco duro|hdd|ssd)\b/i,
                'Cooler/Ventilador': /\b(cooler|ventilador|disipador)\b/i,
                'Procesador/CPU': /\b(procesador|cpu)\b/i,
                'tarjeta': /\b(tarjeta)\b/i,
                'billetero': /\b(billetero)\b/i,
                'ups': /\b(ups)\b/i,
                'mainboard': /\b(mainboard)\b/i,
                'cable': /\b(cable)\b/i,
                'led': /\b(led)\b/i,
                'mux': /\b(mux)\b/i,
                'fuente': /\b(fuente)\b/i,
                'sensor': /\b(sensor)\b/i,
                'botonera': /\b(botonera)\b/i,
                'impresora': /\b(impresora)\b/i,
                'conector': /\b(conector)\b/i,
                'switch': /\b(switch)\b/i,
                'wibu': /\b(wibu)\b/i,
                'crc': /\b(crc)\b/i,
                'placa': /\b(placa)\b/i,
                'boton': /\b(boton)\b/i,
                'bateria': /\b(bateria)\b/i,
                'portafusibles': /\b(portafusibles)\b/i,
                'unidad optica': /\b(unidad optica)\b/i,
                'lector': /\b(lector)\b/i,
                'controlador': /\b(controlador)\b/i,
                'chip': /\b(chip)\b/i
            };
            
            const accion_regex = /\b(cambi[oaó]|reemplaz[oaó]|sustitu|reponer|repuso|cambiandose)\b/i;
            const repuesto_counts = {};

            data.forEach(item => {
                if (!item) {
                    console.warn('analyzeRepuestos: Saltando item nulo.');
                    return; 
                }
                const texto_realizado = item.trab_realizado || '';
                const texto_resultado = item.resul || '';
                
                const texto_completo = texto_realizado + ' ' + texto_resultado;

                if (!accion_regex.test(texto_completo)) {
                    return;
                }

                for (const [key, repuesto_regex] of Object.entries(repuestos_map)) {
                    if (repuesto_regex.test(texto_completo)) {
                        repuesto_counts[key] = (repuesto_counts[key] || 0) + 1;
                    }
                }
            });

            console.log('--- analyzeRepuestos: Conteos finales ---', repuesto_counts);

            return Object.entries(repuesto_counts)
                .map(([repuesto, cantidad]) => ({ repuesto, cantidad }));
        }

        function generateOrangeGradient(count) {
            const colors = []; 
            const s = { r: 249, g: 115, b: 22 }, e = { r: 253, g: 186, b: 116 };
            if (count <= 1) { 
                return [`rgba(${s.r}, ${s.g}, ${s.b}, 0.8)`];
            }
            for (let i = 0; i < count; i++) { 
                const r = i / (count - 1); 
                colors.push(`rgba(${Math.round(s.r + r * (e.r - s.r))}, ${Math.round(s.g + r * (e.g - s.g))}, ${Math.round(s.b + r * (e.b - s.b))}, 0.8)`); 
            }
            return colors;
        }
        
        // --- FUNCIÓN MODIFICADA: updateTopRepuestosUI (con onClick) ---
        function updateTopRepuestosUI(data) {
            const ctx = document.getElementById('topRepuestosChart').getContext('2d');
            const backgroundColors = generateOrangeGradient(data.length);

            if (topRepuestosChartInstance) topRepuestosChartInstance.destroy();
            
            topRepuestosChartInstance = new Chart(ctx, {
                type: 'bar', 
                data: { 
                    labels: data.map(s => s.repuesto), 
                    datasets: [{ 
                        data: data.map(s => s.cantidad), 
                        backgroundColor: backgroundColors,
                        borderRadius: 4,
                        borderWidth: 0
                    }] 
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true, 
                    maintainAspectRatio: false,
                    onHover: (e, el) => e.native.target.style.cursor = el[0] ? 'pointer' : 'default', // Cursor pointer
                    
                    // --- INICIO DE MODIFICACIÓN: onClick para filtrar ---
                    onClick: (event) => {
                        const points = topRepuestosChartInstance.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const repuestoName = topRepuestosChartInstance.data.labels[points[0].index];
                            filterAndShowRepuestoDetails(repuestoName);
                            document.getElementById('reset-view-btn').classList.remove('hidden'); // Mostrar botón reset
                        }
                    },
                    // --- FIN DE MODIFICACIÓN ---

                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            anchor: 'end', 
                            align: 'end',
                            color: '#374151',
                            font: { weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                title: (context) => `Repuesto: ${context[0].label}`,
                                label: (context) => `Cambios: ${context.parsed.x}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'N° de Cambios/Reemplazos'
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { color: '#6B7280' }
                        },
                        y: {
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { color: '#6B7280' }
                        }
                    }
                }
            });
        }

        // --- NUEVA FUNCIÓN: Filtrar y mostrar detalles por repuesto ---
        function filterAndShowRepuestoDetails(repuestoName) {
            console.log(`Filtrando por repuesto: ${repuestoName}`);
            
            // Usar la expresión regular del mapa para filtrar correctamente (maneja sinónimos)
            const repuestoRegex = getRegexForRepuesto(repuestoName);
            const accion_regex = /\b(cambi[oaó]|reemplaz[oaó]|sustitu|reponer|repuso|cambiandose)\b/i;

            const filteredData = rawMachineStatesData.filter(item => {
                const texto_realizado = item.trab_realizado || '';
                const texto_resultado = item.resul || '';
                const texto_completo = texto_realizado + ' ' + texto_resultado;

                return accion_regex.test(texto_completo) && repuestoRegex.test(texto_completo);
            });

            const title = `Reportes donde se cambió: "${repuestoName}" (${filteredData.length} encontrados)`;
            renderDetailsTable(title, filteredData); // Renderiza la tabla con los reportes filtrados
        }

        // --- Helper para obtener la Regex correcta (incluye sinónimos) ---
        function getRegexForRepuesto(repuestoName) {
            const repuestos_map = {
                'Pantalla/Monitor': /\b(monitor|pantalla)\b/i,
                'RAM/Memoria': /\b(ram|memoria)\b/i,
                'Touchscreen': /\b(touchscreen|tactil)\b/i,
                'Disco Duro/SSD': /\b(disco duro|hdd|ssd)\b/i,
                'Cooler/Ventilador': /\b(cooler|ventilador|disipador)\b/i,
                'Procesador/CPU': /\b(procesador|cpu)\b/i,
                'tarjeta': /\b(tarjeta)\b/i,
                'billetero': /\b(billetero)\b/i,
                'ups': /\b(ups)\b/i,
                'mainboard': /\b(mainboard)\b/i,
                'cable': /\b(cable)\b/i,
                'led': /\b(led)\b/i,
                'mux': /\b(mux)\b/i,
                'fuente': /\b(fuente)\b/i,
                'sensor': /\b(sensor)\b/i,
                'botonera': /\b(botonera)\b/i,
                'impresora': /\b(impresora)\b/i,
                'conector': /\b(conector)\b/i,
                'switch': /\b(switch)\b/i,
                'wibu': /\b(wibu)\b/i,
                'crc': /\b(crc)\b/i,
                'placa': /\b(placa)\b/i,
                'boton': /\b(boton)\b/i,
                'bateria': /\b(bateria)\b/i,
                'portafusibles': /\b(portafusibles)\b/i,
                'unidad optica': /\b(unidad optica)\b/i,
                'lector': /\b(lector)\b/i,
                'controlador': /\b(controlador)\b/i,
                'chip': /\b(chip)\b/i
            };
            return repuestos_map[repuestoName] || new RegExp(`\\b${repuestoName.replace(/[-\/\\^$*+?.()|[\]{}]/g, '\\$&')}\\b`, 'i');
        }


        function showAllRepuestosModal() {
            const modal = document.getElementById('repuestos-modal');
            const summary = document.getElementById('repuestos-modal-summary');
            const listDiv = document.getElementById('repuestos-modal-list');

            if (currentAllRepuestos.length === 0) {
                summary.textContent = "No se detectaron cambios de repuestos en los reportes para el rango de fechas seleccionado.";
                listDiv.innerHTML = `<div class="col-span-full text-center py-8 text-gray-500">
                                        <i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i>
                                        <p>Ningún repuesto cambiado encontrado.</p>
                                     </div>`;
            } else {
                const totalChanges = currentAllRepuestos.reduce((sum, item) => sum + item.cantidad, 0);
                const uniqueRepuestos = currentAllRepuestos.length;

                summary.innerHTML = `<p class="font-semibold text-lg">En total, se registraron <span class="text-ws-accent">${totalChanges} cambios</span> de <span class="text-ws-accent">${uniqueRepuestos} tipos de repuestos únicos</span> dentro del periodo seleccionado.</p>
                                     <p class="text-sm mt-2">Aquí puedes ver el detalle de cada repuesto y cuántas veces se ha cambiado:</p>`;

                const sortedRepuestos = [...currentAllRepuestos].sort((a, b) => b.cantidad - a.cantidad);

                listDiv.innerHTML = ''; 
                sortedRepuestos.forEach(item => {
                    const icon = getRepuestoIcon(item.repuesto);
                    listDiv.innerHTML += `
                        <div class="flex items-center p-3 bg-gray-50 rounded-lg shadow-sm">
                            <div class="flex-shrink-0 p-2 bg-orange-100 rounded-full mr-3">
                                <i data-lucide="${icon}" class="w-5 h-5 text-orange-600"></i>
                            </div>
                            <div>
                                <p class="text-md font-semibold text-gray-800 capitalize">${item.repuesto}</p>
                                <p class="text-sm text-gray-600">Cambiado <span class="font-bold">${item.cantidad}</span> veces</p>
                            </div>
                        </div>
                    `;
                });
            }

            modal.style.display = 'flex';
            lucide.createIcons();
        }

        function getRepuestoIcon(repuesto) {
            const icons = {
                'Pantalla/Monitor': 'monitor',
                'RAM/Memoria': 'memory-stick',
                'Touchscreen': 'hand-touch',
                'Disco Duro/SSD': 'hard-drive',
                'Cooler/Ventilador': 'fan',
                'Procesador/CPU': 'cpu',
                'tarjeta': 'chip',
                'billetero': 'wallet',
                'ups': 'power',
                'mainboard': 'motherboard',
                'cable': 'cable',
                'led': 'lightbulb',
                'mux': 'git-fork',
                'fuente': 'battery-charging',
                'sensor': 'radar',
                'botonera': 'gamepad',
                'impresora': 'printer',
                'conector': 'plug',
                'switch': 'toggle-left',
                'wibu': 'key',
                'crc': 'bug',
                'placa': 'circuit-board',
                'boton': 'circle',
                'bateria': 'battery-full',
                'portafusibles': 'box',
                'unidad optica': 'disc',
                'lector': 'scan',
                'controlador': 'sliders',
                'chip': 'chip',
            };
            return icons[repuesto] || 'box'; 
        }

        // --- UI UPDATES & CHARTS ---
        function addCardClickListeners() {
            const cards = document.querySelectorAll('.stats-card[data-status]'); 
            cards.forEach(card => {
                card.addEventListener('click', () => {
                    const status = card.dataset.status;
                    let filteredData;
                    let title;

                    const definidos = ['Operativo', 'Inoperativo', 'Pendiente'];

                    if (status === 'Total') {
                        filteredData = Array.from(lastStatesBySerie.values());
                        title = `Todas las máquinas (${filteredData.length}) con último estado en el rango`;
                    } else if (status === 'Sin Estado') {
                        filteredData = Array.from(lastStatesBySerie.values()).filter(item => 
                            !item.estado || !definidos.includes(item.estado)
                        );
                        title = `Máquinas con estado vacío o no definido (último estado)`;
                    } else {
                        filteredData = Array.from(lastStatesBySerie.values()).filter(item => item.estado === status);
                        title = `Máquinas con último estado: "${status}"`;
                    }
                    renderDetailsTable(title, filteredData); // Usa los datos ya filtrados por último estado
                });
            });
        }

        function updateTitles() {
            const titleEl = document.getElementById('main-title');
            const subtitleEl = document.getElementById('main-subtitle');
            const resetBtn = document.getElementById('reset-view-btn');

            if (selectedSalas.length > 0) {
                let titleText = `Métricas para: ${selectedSalas.length > 2 ? `${selectedSalas.length} salas` : selectedSalas.join(', ')}`;
                titleEl.textContent = titleText;
                subtitleEl.textContent = `Último estado por máquina - Vista filtrada`;
                resetBtn.classList.remove('hidden');
            } else {
                titleEl.textContent = 'Dashboard de Métricas';
                subtitleEl.textContent = 'Último estado por máquina - Análisis actualizado';
                // No ocultamos el botón si hay un filtro de repuesto activo
                // resetBtn.classList.add('hidden'); 
            }
        }

        function updateMachineStatesUI(data) {
            allReportDetails = data;

            const definidos = ['Operativo', 'Inoperativo', 'Pendiente'];

            const operativos = data.filter(m => m.estado === 'Operativo').length;
            const inoperativos = data.filter(m => m.estado === 'Inoperativo').length;
            const pendientes = data.filter(m => m.estado === 'Pendiente').length;
            const sinEstado = data.filter(m => !m.estado || !definidos.includes(m.estado)).length;

            document.getElementById('total-maquinas').textContent = data.length;
            document.getElementById('total-operativas').textContent = operativos;
            document.getElementById('total-inoperativas').textContent = inoperativos;
            document.getElementById('total-pendientes').textContent = pendientes;
            document.getElementById('total-sin-estado').textContent = sinEstado;
        }

        function generateBlueGradient(count) {
            const colors = []; 
            const s = { r: 59, g: 130, b: 246 }, e = { r: 191, g: 219, b: 254 };
            if (count <= 1) { 
                return [`rgba(${s.r}, ${s.g}, ${s.b}, 0.8)`];
            }
            for (let i = 0; i < count; i++) { 
                const r = i / (count - 1); 
                colors.push(`rgba(${Math.round(s.r + r * (e.r - s.r))}, ${Math.round(s.g + r * (e.g - s.g))}, ${Math.round(s.b + r * (e.b - s.b))}, 0.8)`); 
            }
            return colors;
        }

        function updateTopSalasUI(data) {
            const ctx = document.getElementById('topSalasChart').getContext('2d');
            const baseColors = generateBlueGradient(data.length);
            const selectedColor = '#1E40AF';
            const backgroundColors = data.map((s, i) => selectedSalas.includes(s.nombre_sala) ? selectedColor : baseColors[i]);

            if (topSalasChartInstance) topSalasChartInstance.destroy();
            
            topSalasChartInstance = new Chart(ctx, {
                type: 'bar', 
                data: { 
                    labels: data.map(s => s.nombre_sala), 
                    datasets: [{ 
                        data: data.map(s => s.visitas), 
                        backgroundColor: backgroundColors,
                        borderRadius: 4,
                        borderWidth: 0
                    }] 
                },
                options: {
                    indexAxis: 'y', 
                    responsive: true, 
                    maintainAspectRatio: false,
                    onHover: (e, el) => e.native.target.style.cursor = el[0] ? 'pointer' : 'default',
                    
                    onClick: async (event) => {
                        const points = topSalasChartInstance.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const salaName = topSalasChartInstance.data.labels[points[0].index];
                            const selectionIndex = selectedSalas.indexOf(salaName);
                            if (selectionIndex === -1) {
                                selectedSalas.push(salaName);
                            } else {
                                selectedSalas.splice(selectionIndex, 1);
                            }
                            
                            await updateDashboardForSelection(); 

                            // --- INICIO MODIFICACIÓN: Mostrar/Ocultar tabla en click de sala ---
                            const filteredData = Array.from(lastStatesBySerie.values()); 
                            let title;

                            if (selectedSalas.length === 0) {
                                title = "Detalle de todas las máquinas (Vista General)";
                                document.getElementById('sala-details-container').classList.add('hidden'); 
                                document.getElementById('reset-view-btn').classList.add('hidden'); // Ocultar reset si no hay filtro
                            } else {
                                if (selectedSalas.length > 2) {
                                    title = `Detalle de máquinas para ${selectedSalas.length} salas`;
                                } else {
                                    title = `Detalle de máquinas para: ${selectedSalas.join(', ')}`;
                                }
                                renderDetailsTable(title, filteredData); // Mostrar tabla
                                document.getElementById('reset-view-btn').classList.remove('hidden'); // Asegurar que reset esté visible
                            }
                            // --- FIN MODIFICACIÓN ---
                        }
                    },

                    plugins: { 
                        legend: { display: false }, 
                        datalabels: { 
                            anchor: 'end', 
                            align: 'end',
                            color: '#374151',
                            font: { weight: 'bold' }
                        },
                        tooltip: {
                            callbacks: {
                                title: (context) => `Sala: ${context[0].label}`,
                                label: (context) => `Visitas: ${context.parsed.x}`
                            }
                        }
                    },
                    scales: {
                        x: {
                            title: {
                                display: true,
                                text: 'Número de Visitas'
                            },
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { color: '#6B7280' }
                        },
                        y: {
                            grid: { color: 'rgba(0,0,0,0.1)' },
                            ticks: { color: '#6B7280' }
                        }
                    }
                }
            });
        }

        function updateEstadosChart(data) {
            const ctx = document.getElementById('estadosChart').getContext('2d');
            
            const estadoCounts = {
                'Operativo': 0,
                'Inoperativo': 0,
                'Pendiente': 0,
                'Sin Estado': 0
            };

            data.forEach(m => {
                if (m.estado === 'Operativo') estadoCounts['Operativo']++;
                else if (m.estado === 'Inoperativo') estadoCounts['Inoperativo']++;
                else if (m.estado === 'Pendiente') estadoCounts['Pendiente']++;
                else estadoCounts['Sin Estado']++;
            });

            const labels = Object.keys(estadoCounts);
            const counts = Object.values(estadoCounts);
            
            const backgroundColors = [
                'rgba(34, 197, 94, 0.8)',   // Verde para Operativo
                'rgba(239, 68, 68, 0.8)',   // Rojo para Inoperativo
                'rgba(245, 158, 11, 0.8)',  // Amarillo para Pendiente
                'rgba(156, 163, 175, 0.8)'  // Gris para Sin Estado
            ];

            if (estadosChartInstance) estadosChartInstance.destroy();
            
            estadosChartInstance = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: labels,
                    datasets: [{
                        data: counts,
                        backgroundColor: backgroundColors,
                        borderWidth: 2,
                        borderColor: 'white'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '60%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                padding: 20,
                                usePointStyle: true,
                                pointStyle: 'circle'
                            }
                        },
                        datalabels: {
                            color: 'white',
                            font: {
                                weight: 'bold',
                                size: 12
                            },
                            formatter: (value, context) => {
                                const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                                if (total === 0) return '0%';
                                const percentage = ((value / total)* 100).toFixed(1);
                                if (percentage < 5) return ''; 
                                return `${percentage}%`;
                            }
                        },
                        tooltip: {
                            callbacks: {
                                label: (context) => {
                                    const total = context.dataset.data.reduce((a, b) => a + b, 0);
                                    if (total === 0) return `${context.label}: 0 máquinas (0%)`;
                                    const percentage = ((context.parsed / total) * 100).toFixed(1);
                                    return `${context.label}: ${context.parsed} máquinas (${percentage}%)`;
                                }
                            }
                        }
                    }
                }
            });
        }

        async function updateDashboardForSelection() {
            document.getElementById('loading-overlay').style.display = 'flex';
            updateTitles();

            const startDate = document.getElementById('start-date').value;
            const endDate = document.getElementById('end-date').value;
            const typeFilter = document.getElementById('type-filter').value;

            // Fetch data based on selected salas
            const machineStates = await fetchMachineStates(startDate, endDate, typeFilter, selectedSalas);
            rawMachineStatesData = machineStates; // Update raw data based on selection for repuesto analysis

            // Fetch top salas always without sala filter for the chart
            const topSalas = await fetchTopSalas(startDate, endDate, typeFilter);

            console.log('--- updateDashboardForSelection: Datos crudos de fetchMachineStates ---');
            console.log(rawMachineStatesData);

            const allRepuestos = analyzeRepuestos(rawMachineStatesData);
            currentAllRepuestos = allRepuestos;
            const topRepuestosData = [...allRepuestos].sort((a,b) => b.cantidad - a.cantidad).slice(0, 15);

            const lastStatesData = getLastStateBySerie(rawMachineStatesData);
            allReportDetails = lastStatesData; // Update global for card clicks
            lastStatesBySerie = new Map(lastStatesData.map(item => [item.maquinas.serie, item]));

            updateMachineStatesUI(lastStatesData);
            updateTopSalasUI(topSalas); // Update chart with overall top salas
            updateEstadosChart(lastStatesData);
            updateTopRepuestosUI(topRepuestosData); 

            document.getElementById('loading-overlay').style.display = 'none';
        }

        // --- FUNCIÓN MODIFICADA: renderDetailsTable (con tooltips) ---
        function renderDetailsTable(title, data) {
            const container = document.getElementById('sala-details-container');
            const tableDiv = document.getElementById('sala-details-table');
            document.getElementById('sala-details-title').textContent = title;
            
            if (!data || data.length === 0) {
                tableDiv.innerHTML = '<div class="text-center py-8 text-gray-500"><i data-lucide="inbox" class="w-12 h-12 mx-auto mb-3 text-gray-400"></i><p>No se encontraron datos para esta selección.</p></div>';
                container.classList.remove('hidden');
                lucide.createIcons();
                return;
            }

            let tableHTML = `<div class="overflow-x-auto"><table class="min-w-full divide-y divide-gray-200"><thead class="bg-gray-50"><tr>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Serie</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Sala</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Técnico</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Gabinete</th>
                <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Estado Final</th>
            </tr></thead><tbody class="bg-white divide-y divide-gray-200">`;

            // Helper para limpiar texto para el tooltip
            const cleanText = (text) => text ? text.replace(/"/g, '&quot;').replace(/\n/g, ' ') : 'N/A';

            data.forEach(item => {
                const fecha = item.trabajos.fecha ? new Date(item.trabajos.fecha + 'T00:00:00').toLocaleDateString('es-ES') : 'N/A';
                const serie = item.maquinas ? item.maquinas.serie : 'N/A';
                const sala = item.trabajos.sala ? item.trabajos.sala.sala_mincetur : 'N/A';
                const tecnico = item.trabajos.tecnicos ? item.trabajos.tecnicos.usuario : 'N/A';
                const gabinete = getGabineteTypeBySerie(serie);
                const estado = item.estado || 'Sin estado';

                // --- INICIO MODIFICACIÓN: Crear contenido del tooltip ---
                const diagIni = cleanText(item.diag_ini);
                const trabRealizado = cleanText(item.trab_realizado);
                const resul = cleanText(item.resul);
                const tooltipContent = `DIAG: ${diagIni} | TRAB: ${trabRealizado} | RES: ${resul}`;
                // --- FIN MODIFICACIÓN ---

                tableHTML += `<tr class="hover:bg-gray-50 transition-colors">
                    <td class="px-4 py-4 whitespace-nowrap text-sm font-mono font-medium text-gray-900">${serie}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${fecha}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${sala}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${tecnico}</td>
                    <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${gabinete}</td>
                    <td class="px-4 py-4 whitespace-nowrap">
                        <span title="${tooltipContent}" class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium ${
                            estado === 'Operativo' ? 'bg-green-100 text-green-800' :
                            estado === 'Inoperativo' ? 'bg-red-100 text-red-800' :
                            estado === 'Pendiente' ? 'bg-yellow-100 text-yellow-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${estado}
                        </span>
                    </td>
                </tr>`;
            });
            
            tableHTML += `</tbody></table></div>`;
            tableDiv.innerHTML = tableHTML;
            container.classList.remove('hidden');
            container.scrollIntoView({ behavior: 'smooth', block: 'start' });
            lucide.createIcons();
        }

        // --- STARTUP ---
        document.addEventListener('DOMContentLoaded', checkSession);
    </script>
</body>
</html>
