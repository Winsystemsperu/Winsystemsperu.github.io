<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reporte de Incidencias</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f2f5;
        }

        .card-enter {
            opacity: 0;
            transform: translateY(20px);
            animation: card-enter-animation 0.5s forwards;
        }

        @keyframes card-enter-animation {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        #loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(240, 242, 245, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            transition: opacity 0.3s;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 10000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            transition: opacity 0.3s ease;
        }

        .modal-content {
            background-color: #fefefe;
            margin: 10% auto;
            padding: 24px;
            border: 1px solid #888;
            width: 90%;
            max-width: 900px;
            border-radius: 12px;
            position: relative;
        }

        .nav-button {
            padding: 8px 16px;
            border-radius: 8px;
            font-weight: 500;
            transition: background-color 0.2s, color 0.2s;
            cursor: pointer;
        }

        .nav-button.active {
            background-color: #3b82f6;
            color: white;
        }

        .nav-button:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }

        .tooltip-container {
            position: relative;
            display: inline-block;
            cursor: help;
        }

        .tooltip-bubble {
            visibility: hidden;
            width: 400px;
            background-color: #262626;
            color: #fff;
            text-align: left;
            white-space: normal;
            border-radius: 6px;
            padding: 8px 12px;
            position: absolute;
            z-index: 20;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            opacity: 0;
            transition: opacity 0.3s;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            font-size: 0.8rem;
            line-height: 1.4;
        }

        .tooltip-bubble::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #262626 transparent transparent transparent;
        }

        .tooltip-container:hover .tooltip-bubble {
            visibility: visible;
            opacity: 1;
        }

        .table-header {
            background-color: #f9fafb;
        }

        .status-operativo {
            background-color: #ecfdf5;
        }

        .status-inoperativo {
            background-color: #ffb7b7;
        }

        .status-pendiente {
            background-color: #f1c462;
        }

        .status-retirado {
            background-color: #888;
        }

        /* --- MODIFICADO: Estilos para botones de máquinas (más pequeños y llamativos) --- */
        .machine-button {
            padding: 8px 4px;
            border-radius: 8px;
            width: 6rem;
            border: 1px solid #e5e7eb;
            text-align: center;
            transition: all 0.2s ease-in-out;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
            color: #374151;
        }

        /* --- NUEVO: COLORES DE ESTADO PARA LOS BOTONES --- */
        .machine-button.status-operativo {
            background-color: #f0fdf4;
            border-color: #bbf7d0;
        }

        .machine-button.status-operativo:hover {
            background-color: #dcfce7;
            border-color: #86efac;
        }

        .machine-button.status-inoperativo {
            background-color: #ffa5a5;
            border-color: #ff0000;
        }

        .machine-button.status-inoperativo:hover {
            background-color: #fd7878;
            border-color: #d60000;
        }

        .machine-button.status-pendiente {
            background-color: #fffbeb;
            border-color: #fde68a;
        }

        .machine-button.status-pendiente:hover {
            background-color: #fef3c7;
            border-color: #fcd34d;
        }

        .machine-button.status-retirado {
            background-color: #f1f5f9;
            border-color: #e2e8f0;
            color: #64748b;
        }

        .machine-button.status-retirado:hover {
            background-color: #e2e8f0;
            border-color: #cbd5e1;
        }

        /* --- ESTADO SELECCIONADO (Tiene prioridad sobre los demás) --- */
        .machine-button.selected {
            background-color: #2563eb !important;
            /* !important asegura que siempre sea azul al seleccionar */
            border-color: #1d4ed8 !important;
            color: white !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .machine-button.selected .machine-model {
            color: #dbeafe !important;
        }


        /* --- MEJORAS PARA LA SECCIÓN DE INCIDENCIAS --- */
        .incidencia-section {
            background: white;
            border-radius: 12px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
        }

        .incidencia-header {
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 1rem;
            margin-bottom: 1.5rem;
        }

        .incidencia-form-group {
            margin-bottom: 1.5rem;
        }

        .incidencia-label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .incidencia-textarea {
            width: 100%;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            padding: 0.75rem;
            font-family: inherit;
            transition: border-color 0.2s;
        }

        .incidencia-textarea:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        .history-table {
            width: 100%;
            border-collapse: collapse;
        }

        .history-table th {
            background-color: #f9fafb;
            padding: 0.75rem;
            text-align: left;
            font-weight: 500;
            color: #6b7280;
            border-bottom: 1px solid #e5e7eb;
        }

        .history-table td {
            padding: 0.75rem;
            border-bottom: 1px solid #e5e7eb;
        }

        .history-table tr:last-child td {
            border-bottom: none;
        }
    </style>
</head>

<body class="text-gray-800">

    <div id="loading-overlay">
        <div class="text-center">
            <i data-lucide="loader-2" class="animate-spin h-12 w-12 text-blue-600"></i>
            <p id="loading-text" class="mt-4 text-lg font-semibold text-gray-700">Verificando sesión...</p>
        </div>
    </div>

    <div class="container mx-auto p-4 md:p-8 opacity-0" id="main-content">

        <header class="mb-6 flex flex-wrap justify-between items-center">
            <div class="flex items-center space-x-4">
                <img src="winsystems_logo.png"    
                    alt="Logo de Winsystems" class="h-24">
                <div>
                    <h1 id="main-title" class="text-3xl font-bold text-gray-900">Dashboard de Operaciones</h1>
                    <p id="main-subtitle" class="text-gray-500">Análisis interactivo de la operación.</p>
                </div>
            </div>
            <div class="flex items-center space-x-4 mt-4 md:mt-0">
                <div id="main-nav" class="flex space-x-2 bg-gray-200 p-1 rounded-lg">
                    <button id="nav-maquinas" class="nav-button active">Máquinas</button>
                    <button id="nav-tecnicos" class="nav-button">Técnicos</button>
                    <button id="nav-reporte" class="nav-button">Reporte</button>
                    <a id="nav-asignacion" href="./asignacion.html" class="nav-button hidden">Asignaciones</a>
                    <button id="nav-incidencia" class="nav-button hidden">Reportar Incidencia</button>
                </div>
                <button id="logout-button" title="Cerrar Sesión"
                    class="p-2 rounded-full text-gray-500 hover:bg-gray-200 hover:text-gray-800 transition">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </header>

        <div id="filters-section" class="bg-white p-4 rounded-xl shadow-md mb-8 flex-wrap items-end gap-4"
            style="display: none;">
            <div class="flex-grow">
                <label for="start-date" class="block text-sm font-medium text-gray-700">Fecha Inicio</label>
                <input type="date" id="start-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>
            <div class="flex-grow">
                <label for="end-date" class="block text-sm font-medium text-gray-700">Fecha Fin</label>
                <input type="date" id="end-date" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
            </div>

            <div id="gabinete-filter-container" class="flex-grow">
                <label for="type-filter" class="block text-sm font-medium text-gray-700">Tipo de Gabinete</label>
                <select id="type-filter" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm">
                    <option>Todos</option>
                </select>
            </div>
            <div id="tecnico-filter-container" class="flex-grow hidden">
                <label class="block text-sm font-medium text-gray-700">Técnicos</label>
                <div class="relative mt-1"><button id="tecnico-filter-btn"
                        class="w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default"><span
                            id="tecnico-filter-text" class="block truncate">Todos los técnicos</span><span
                            class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none"><i
                                data-lucide="chevrons-up-down" class="h-5 w-5 text-gray-400"></i></span></button>
                    <div id="tecnico-filter-options"
                        class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto">
                    </div>
                </div>
            </div>
            <div id="departamento-filter-container" class="flex-grow hidden"><label
                    class="block text-sm font-medium text-gray-700">Departamento</label>
                <div class="relative mt-1"><button id="departamento-filter-btn"
                        class="w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default"><span
                            id="departamento-filter-text" class="block truncate">Todos</span></button>
                    <div id="departamento-filter-options"
                        class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto">
                    </div>
                </div>
            </div>
            <div id="sala-filter-container" class="flex-grow hidden"><label
                    class="block text-sm font-medium text-gray-700">Sala</label>
                <div class="relative mt-1"><button id="sala-filter-btn"
                        class="w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default"><span
                            id="sala-filter-text" class="block truncate">Todas</span></button>
                    <div id="sala-filter-options"
                        class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto">
                    </div>
                </div>
            </div>
            <div id="work-type-filter-container" class="flex-grow hidden"><label
                    class="block text-sm font-medium text-gray-700">Tipo de Trabajo</label>
                <div class="relative mt-1"><button id="work-type-filter-btn"
                        class="w-full bg-white border border-gray-300 rounded-md shadow-sm pl-3 pr-10 py-2 text-left cursor-default"><span
                            id="work-type-filter-text" class="block truncate">Todos</span></button>
                    <div id="work-type-filter-options"
                        class="hidden absolute z-10 mt-1 w-full bg-white shadow-lg max-h-60 rounded-md py-1 text-base ring-1 ring-black ring-opacity-5 overflow-auto">
                    </div>
                </div>
            </div>

            <button id="apply-filters"
                class="bg-blue-600 text-white px-4 py-2 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2"><i
                    data-lucide="filter" class="w-4 h-4"></i> Aplicar</button>
        </div>

        <div id="maquinas-dashboard" class="hidden">
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
                <div class="card-enter bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                    <div class="bg-blue-100 p-3 rounded-full"><i data-lucide="server" class="text-blue-600"></i></div>
                    <div>
                        <p class="text-gray-500 text-sm">Total Ruletas/Slot Atendidas</p>
                        <p id="total-maquinas" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div class="card-enter bg-white p-6 rounded-xl shadow-md flex items-center space-x-4">
                    <div class="bg-green-100 p-3 rounded-full"><i data-lucide="check-circle" class="text-green-600"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Operativas</p>
                        <p id="total-operativas" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div id="card-inoperativas"
                    class="card-enter bg-white p-6 rounded-xl shadow-md flex items-center space-x-4 hover:bg-red-50 cursor-pointer transition">
                    <div class="bg-red-100 p-3 rounded-full"><i data-lucide="alert-triangle" class="text-red-600"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Inoperativas</p>
                        <p id="total-inoperativas" class="text-2xl font-bold">0</p>
                    </div>
                </div>
                <div id="card-pendientes"
                    class="card-enter bg-white p-6 rounded-xl shadow-md flex items-center space-x-4 hover:bg-yellow-50 cursor-pointer transition">
                    <div class="bg-yellow-100 p-3 rounded-full"><i data-lucide="clock" class="text-yellow-600"></i>
                    </div>
                    <div>
                        <p class="text-gray-500 text-sm">Pendientes</p>
                        <p id="total-pendientes" class="text-2xl font-bold">0</p>
                    </div>
                </div>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">

                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Top 15 Salas Más Visitadas</h2>
                    <div class="h-96"><canvas id="topSalasChart"></canvas></div>
                </div>

                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Top 5 Tipos de Trabajo</h2>
                    <div class="h-96"><canvas id="topTrabajosChart"></canvas></div>
                </div>

                <div id="sala-details-container" class="hidden mt-8">
                    <div class="bg-white p-6 rounded-xl shadow-md">
                        <h2 id="sala-details-title" class="text-xl font-semibold mb-4">Detalles de la Sala</h2>
                        <div id="sala-details-table" class="overflow-x-auto">
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tecnicos-dashboard" class="hidden">
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Horas Trabajadas por Técnico</h2>
                    <div class="h-96"><canvas id="horasTecnicoChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Tiempo Promedio por Tipo de Trabajo (Horas)</h2>
                    <div class="h-96"><canvas id="avgTimeChart"></canvas></div>
                </div>
                <div class="lg:col-span-2 bg-white p-6 rounded-xl shadow-md">
                    <h2 class="text-xl font-semibold mb-4">Visitas a Salas por Técnico</h2>
                    <div id="visitasTecnicoContainer" class="max-h-96 overflow-y-auto"></div>
                </div>
            </div>
        </div>

        <div id="reporte-dashboard" class="hidden">
            <div class="bg-white p-6 rounded-xl shadow-md">
                <h2 class="text-xl font-semibold mb-4">Reporte Detallado de Operaciones</h2>
                <div class="overflow-x-auto">
                    <table id="admin-report-table" class="min-w-full divide-y divide-gray-200">
                        <thead class="table-header">
                            <tr>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Fecha</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Slot/Ruleta</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Serie</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Sala</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Incidencia</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Estado</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Técnico</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Razón Social</th>
                                <th
                                    class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                    Ubicación</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                    </table>
                </div>
            </div>
        </div>

        <div id="incidencia-dashboard" class="hidden">
            <div class="incidencia-section">
                <div class="incidencia-header">
                    <h2 class="text-2xl font-semibold text-gray-800">Control de estado actual de Maquinas y Ruletas</h2>
                </div>

                <div id="sala-info" class="mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200 text-center">
                    <h3 class="font-semibold text-blue-800">Sala De Juegos:<span id="sala-nombre">Cargando...</span>
                    </h3>
                    <p class="text-blue-600 text-sm mt-1" id="sala-detalles"></p>
                </div>

                <form id="incidencia-form" class="space-y-6">
                    <div class="incidencia-form-group">
                        <label class="incidencia-label">1. Seleccione una Ruleta o Maquina</label>
                        <div id="maquinas-container" class="grid grid-cols-4 md:grid-cols-8 lg:grid-cols-10 gap-3">
                            <div class="text-center py-8 text-gray-400">
                                <i data-lucide="loader-2" class="animate-spin h-8 w-8 mx-auto"></i>
                                <p class="mt-2">Cargando máquinas...</p>
                            </div>
                        </div>
                        <p id="no-machines-message" class="text-center py-4 text-gray-500 hidden">
                            No hay máquinas registradas en esta sala.
                        </p>
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 hidden">
                        <div>
                            <label for="incidencia-tipo-trabajo" class="incidencia-label">Tipo de Trabajo</label>
                            <select id="incidencia-tipo-trabajo" name="tipo_trabajo" required
                                class="incidencia-textarea">
                                <option value="Asistencia Remota" selected>Asistencia Remota</option>
                            </select>
                        </div>
                        <div>
                            <label for="incidencia-estado" class="incidencia-label">Estado Final de la Máquina</label>
                            <select id="incidencia-estado" name="estado" required class="incidencia-textarea">
                                <option value="Inoperativo" selected>Inoperativo</option>
                            </select>
                        </div>
                    </div>

                    <div class="incidencia-form-group">
                        <label for="incidencia-diag" class="incidencia-label">2. Describa la incidencia</label>
                        <textarea id="incidencia-diag" name="diag_ini" rows="4" class="incidencia-textarea"
                            placeholder="Describa el problema o incidencia detectada..." required></textarea>
                    </div>

                    <div class="flex justify-end pt-4">
                        <button type="submit"
                            class="bg-blue-600 text-white px-6 py-3 rounded-lg shadow hover:bg-blue-700 flex items-center gap-2 transition-colors font-medium">
                            <i data-lucide="send" class="w-5 h-5"></i> Enviar Reporte
                        </button>
                    </div>
                </form>
            </div>

            <div class="incidencia-section">
                <h2 class="text-xl font-semibold mb-4 text-gray-800">Historial de Incidencias de la Máquina o
                    Seleccionada</h2>
                <div class="bg-gray-50 p-4 rounded-lg overflow-x-auto">
                    <table class="history-table">
                        <thead>
                            <tr>
                                <th class="text-left font-medium text-gray-700">Fecha</th>
                                <th class="text-left font-medium text-gray-700">Tipo de Trabajo</th>
                                <th class="text-left font-medium text-gray-700">Detalles</th>
                                <th class="text-left font-medium text-gray-700">Estado Final</th>
                            </tr>
                        </thead>
                        <tbody id="incidencia-history-body">
                            <tr>
                                <td colspan="4" class="text-center text-gray-500 py-4">Seleccione una máquina para ver
                                    su historial.</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div id="details-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-2xl font-bold">Detalle</h2><button id="modal-close-btn"
                    class="text-gray-500 hover:text-gray-800"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div id="modal-body" class="max-h-96 overflow-y-auto"></div>
        </div>
    </div>

    <script>
        // --- CONFIG & GLOBAL VARS ---
        const SUPABASE_URL = 'https://qobquktxvhlvtrpeopji.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvYnF1a3R4dmhsdnRycGVvcGppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU2OTc4NDYsImV4cCI6MjA2MTI3Mzg0Nn0.rnubNUWSWEomj5Xwvr65kZLK7Ig_bLC74ajFh9cksFc';
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        Chart.register(ChartDataLabels);

        // ▼▼▼ AGREGA ESTA NUEVA FUNCIÓN ▼▼▼
        function getPeruDateTime() {
            const ahora = new Date();
            const timeZone = 'America/Lima';

            // --- Obtener Fecha en formato YYYY-MM-DD ---
            const dateFormatter = new Intl.DateTimeFormat('es-PE', {
                timeZone,
                year: 'numeric',
                month: '2-digit',
                day: '2-digit'
            });
            const parts = dateFormatter.formatToParts(ahora);
            const day = parts.find(p => p.type === 'day').value;
            const month = parts.find(p => p.type === 'month').value;
            const year = parts.find(p => p.type === 'year').value;
            const fecha = `${year}-${month}-${day}`;

            // --- Obtener Hora en formato HH:mm:ss ---
            const hora = ahora.toLocaleTimeString('es-PE', {
                timeZone,
                hour12: false,
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit'
            });

            return { fecha, hora }; // Devuelve un objeto con la fecha y hora correctas
        }

        // --- DOM ELEMENTS ---
        const mainContent = document.getElementById('main-content');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        const logoutButton = document.getElementById('logout-button');
        const navMaquinasBtn = document.getElementById('nav-maquinas');
        const navTecnicosBtn = document.getElementById('nav-tecnicos');
        const navReporteBtn = document.getElementById('nav-reporte');
        const navIncidenciaBtn = document.getElementById('nav-incidencia');
        const maquinasDashboard = document.getElementById('maquinas-dashboard');
        const tecnicosDashboard = document.getElementById('tecnicos-dashboard');
        const reporteDashboard = document.getElementById('reporte-dashboard');
        const incidenciaDashboard = document.getElementById('incidencia-dashboard');
        const filtersSection = document.getElementById('filters-section');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const applyFiltersBtn = document.getElementById('apply-filters');
        const detailsModal = document.getElementById('details-modal');
        const modalTitle = document.getElementById('modal-title');
        const modalBody = document.getElementById('modal-body');
        const modalCloseBtn = document.getElementById('modal-close-btn');
        const gabineteFilterContainer = document.getElementById('gabinete-filter-container');
        const typeFilterInput = document.getElementById('type-filter');
        const tecnicoFilterContainer = document.getElementById('tecnico-filter-container');
        const tecnicoFilterBtn = document.getElementById('tecnico-filter-btn');
        const tecnicoFilterText = document.getElementById('tecnico-filter-text');
        const tecnicoFilterOptions = document.getElementById('tecnico-filter-options');
        const departamentoFilterContainer = document.getElementById('departamento-filter-container');
        const departamentoFilterBtn = document.getElementById('departamento-filter-btn');
        const departamentoFilterText = document.getElementById('departamento-filter-text');
        const departamentoFilterOptions = document.getElementById('departamento-filter-options');
        const salaFilterContainer = document.getElementById('sala-filter-container');
        const salaFilterBtn = document.getElementById('sala-filter-btn');
        const salaFilterText = document.getElementById('sala-filter-text');
        const salaFilterOptions = document.getElementById('sala-filter-options');
        const workTypeFilterContainer = document.getElementById('work-type-filter-container');
        const workTypeFilterBtn = document.getElementById('work-type-filter-btn');
        const workTypeFilterText = document.getElementById('work-type-filter-text');
        const workTypeFilterOptions = document.getElementById('work-type-filter-options');
        const incidenciaForm = document.getElementById('incidencia-form');
        const incidenciaDiagTextarea = document.getElementById('incidencia-diag');
        const maquinasContainer = document.getElementById('maquinas-container');
        const noMachinesMessage = document.getElementById('no-machines-message');
        const salaNombre = document.getElementById('sala-nombre');
        const salaDetalles = document.getElementById('sala-detalles');
        const incidenciaHistoryBody = document.getElementById('incidencia-history-body');

        // --- STATE ---
        let currentUser = null;
        let topTrabajosChartInstance, topSalasChartInstance, horasTecnicoChartInstance, avgTimeChartInstance;
        let currentMachineStates = [], allTechnicians = [], allDepartamentos = [], allSalas = [], allWorkTypes = [];
        const colorPalette = ['rgba(59, 130, 246, 0.7)', 'rgba(239, 68, 68, 0.7)', 'rgba(245, 158, 11, 0.7)', 'rgba(34, 197, 94, 0.7)', 'rgba(139, 92, 246, 0.7)', 'rgba(236, 72, 153, 0.7)', 'rgba(14, 165, 233, 0.7)'];
        let userSalaId = null;
        let selectedMachineId = null;
        let realtimeSubscription = null;

        // ▼▼▼ AGREGA ESTA FUNCIÓN NUEVA ▼▼▼
        async function fetchLatestMachineStates(salaId) {
            const { data, error } = await supabaseClient
                .from('trabajos')
                .select('detalle!inner(id_maquina, estado)')
                .eq('id_sala', salaId)
                .not('detalle', 'is', 'null')
                .order('fecha', { ascending: false })
                .order('id_trabajo', { ascending: false });

            if (error) {
                console.error("Error fetching machine states:", error);
                return {};
            }

            const latestStates = {};
            data.forEach(trabajo => {
                trabajo.detalle.forEach(item => {
                    // Como los datos vienen ordenados del más nuevo al más viejo,
                    // la primera vez que veamos una máquina, ese será su último estado.
                    if (item.id_maquina && !latestStates[item.id_maquina]) {
                        latestStates[item.id_maquina] = item.estado;
                    }
                });
            });
            return latestStates;
        }

        // --- SESSION MANAGEMENT ---
        async function checkSession() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            if (error || !session) {
                logout();
            } else {
                currentUser = session.user;
                await initializeDashboard();
            }
        }

        async function logout() {
            if (realtimeSubscription) {
                supabaseClient.removeChannel(realtimeSubscription);
                realtimeSubscription = null;
            }
            await supabaseClient.auth.signOut();
            window.location.href = './index.html';
        }

        // --- ROLE-BASED INITIALIZATION ROUTER ---
        async function initializeDashboard() {
            lucide.createIcons();
            loadingText.textContent = 'Verificando perfil de usuario...';

            const { data: tecnicoData, error: tecnicoError } = await supabaseClient
                .from('tecnicos')
                .select('cargo, docum')
                .eq('id_usuario', currentUser.id)
                .single();

            if (tecnicoError || !tecnicoData) {
                alert("Tu usuario está autenticado pero no se encuentra registrado. Contacta al administrador.");
                logout();
                return;
            }

            // ▼▼▼ LÓGICA AÑADIDA PARA MOSTRAR EL BOTÓN ▼▼▼
            // Verificamos el cargo del usuario para mostrar botones condicionales
            const userRole = tecnicoData.cargo.toLowerCase();
            if (userRole === 'coordinador' || userRole === 'admin') {
                // Si es coordinador o admin, mostramos el botón de Asignaciones
                document.getElementById('nav-asignacion').classList.remove('hidden');
            }
            // ▲▲▲ FIN DE LA LÓGICA AÑADIDA ▲▲▲

            if (userRole === 'sala') {
                await initializeSalaTechnicianView(tecnicoData);
            } else {
                await initializeAdminView();
            }

            mainContent.classList.remove('opacity-0');
            mainContent.classList.add('opacity-100');
            loadingOverlay.style.opacity = '0';
            setTimeout(() => loadingOverlay.style.display = 'none', 300);
            logoutButton.addEventListener('click', logout);
        }
        // =================================================================
        // --- REALTIME SUBSCRIPTION LOGIC ---
        // =================================================================
        function setupRealtimeSubscription(callback) {
            if (realtimeSubscription) {
                supabaseClient.removeChannel(realtimeSubscription);
            }
            realtimeSubscription = supabaseClient.channel('public:detalle')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'detalle' }, (payload) => {
                    console.log('Realtime change received!', payload);
                    callback(payload); // Pasamos el payload al callback
                })
                .subscribe();
            console.log("Realtime subscription setup complete.");
        }


        // =================================================================
        // --- SALA TECHNICIAN VIEW LOGIC ---
        // =================================================================

        async function initializeSalaTechnicianView(tecnicoData) {
            // ▼▼▼ AQUÍ AGREGAS LAS LÍNEAS PARA CAMBIAR EL TÍTULO ▼▼▼
            document.getElementById('main-title').textContent = 'Reporte de Incidencias de Sala';
            document.getElementById('main-subtitle').textContent = ''; // Limpiamos el subtítulo
            // ▲▲▲ FIN DE LA MODIFICACIÓN ▲▲▲

            document.getElementById('main-nav').classList.add('hidden');
            filtersSection.classList.add('hidden');
            incidenciaDashboard.classList.remove('hidden');

            await loadSalaData(tecnicoData.docum);

            incidenciaForm.addEventListener('submit', handleIncidenciaSubmit);

            // Setup realtime updates
            setupRealtimeSubscription((payload) => {
                console.log("Realtime update triggered for Sala view.");
                // Si hay una máquina seleccionada y el cambio corresponde a ella, actualizamos su historial
                if (selectedMachineId && payload.new.id_maquina === selectedMachineId) {
                    console.log(`Updating history for selected machine: ${selectedMachineId}`);
                    loadHistoryForMachine(selectedMachineId);
                }
            });
        }

        async function loadSalaData(salaId) {
            userSalaId = salaId;
            loadingText.textContent = 'Cargando datos de la sala...';
            try {
                const { data: salaData, error: salaError } = await supabaseClient
                    .from('sala')
                    .select('id_sala, sala_mincetur, empresa, direccion, departamento')
                    .eq('id_sala', salaId)
                    .single();

                if (salaError) throw salaError;

                salaNombre.textContent = salaData.sala_mincetur;
                salaDetalles.textContent = `${salaData.empresa} - ${salaData.direccion}, ${salaData.departamento}`;

                // ▼▼▼ MODIFICACIÓN AQUÍ ▼▼▼
                // 1. Obtenemos los estados primero
                const latestStates = await fetchLatestMachineStates(salaId);
                // 2. Los pasamos al crear las máquinas
                await loadMachinesForSala(salaId, latestStates);

            } catch (error) {
                console.error('Error al cargar datos de la sala:', error);
                alert('No se pudo cargar la información de su sala asignada. Contacte al administrador.');
                logout();
            }
        }

        // ▼▼▼ REEMPLAZA TU FUNCIÓN ENTERA CON ESTA ▼▼▼
        async function loadMachinesForSala(salaId, latestStates = {}) { // Ahora recibe los estados
            try {
                const { data: machinesData, error } = await supabaseClient
                    .from('maquinas')
                    .select('id_maquina, serie, modelo, gabinete')
                    .eq('id_sala', salaId)
                    .order('serie');
                if (error) throw error;

                maquinasContainer.innerHTML = '';

                if (machinesData.length === 0) {
                    noMachinesMessage.classList.remove('hidden');
                    return;
                }

                noMachinesMessage.classList.add('hidden');

                machinesData.forEach(machine => {
                    const machineButton = document.createElement('button');
                    machineButton.type = 'button';
                    machineButton.className = 'machine-button'; // Clase base
                    machineButton.dataset.id = machine.id_maquina;

                    // --- LÓGICA PARA APLICAR EL COLOR DE ESTADO ---
                    const lastStatus = latestStates[machine.id_maquina];
                    if (lastStatus) {
                        const statusClass = `status-${lastStatus.toLowerCase()}`;
                        machineButton.classList.add(statusClass);
                    }
                    // --- FIN DE LA LÓGICA DE COLOR ---

                    machineButton.innerHTML = `
                        <div class="machine-serie">${machine.serie}</div>
                        <div class="machine-model">${machine.modelo || 'Sin modelo'}</div>
                    `;

                    machineButton.addEventListener('click', () => {
                        // Limpia el estado 'selected' de cualquier otro botón
                        document.querySelectorAll('.machine-button.selected').forEach(btn => btn.classList.remove('selected'));
                        // Añade 'selected' al botón clickeado
                        machineButton.classList.add('selected');
                        selectedMachineId = machine.id_maquina;
                        loadHistoryForMachine(machine.id_maquina);
                    });

                    maquinasContainer.appendChild(machineButton);
                });
                lucide.createIcons();
            } catch (error) {
                console.error('Error al cargar máquinas:', error);
                maquinasContainer.innerHTML = '<p class="text-red-500 col-span-full">Error al cargar las máquinas.</p>';
            }
        }

        // ▼▼▼ NUEVA FUNCIÓN: Carga el historial para una sola máquina ▼▼▼
        async function loadHistoryForMachine(machineId) {
            try {
                const { data, error } = await supabaseClient
                    .from('detalle')
                    .select(`
                estado, tipo_trabajo, diag_ini, trab_realizado, resul,
                trabajos!inner(
                    fecha,
                    tecnicos(usuario, correo, cel, cargo)
                )
            `)
                    .eq('id_maquina', machineId)
                    .order('fecha', { foreignTable: 'trabajos', ascending: false });

                if (error) throw error;

                const historyBody = document.getElementById('incidencia-history-body');
                historyBody.innerHTML = '';

                if (data.length === 0) {
                    historyBody.innerHTML = `<tr><td colspan="5" class="px-4 py-4 text-center text-gray-500">No hay historial para esta máquina.</td></tr>`;
                    return;
                }
                const tecnico = item.trabajos.tecnicos;
                let tecnicoInfoHTML = ''; // Empezamos con un string vacío

                if (tecnico) {
                    // Si encontramos un técnico/usuario, mostramos sus datos
                    tecnicoInfoHTML = `
                    <div class="font-medium text-gray-900">${tecnico.usuario}</div>
                    <div class="text-xs text-gray-500">${tecnico.correo || ''}</div>
                    <div class="text-xs text-gray-500">${tecnico.cel || ''}</div>
                `;
                } else {
                    // Si por alguna razón no hay usuario, mostramos un texto genérico
                    tecnicoInfoHTML = '<span class="text-xs text-gray-400">Usuario no encontrado</span>';
                }

                // ▼▼▼ ESTA ES LA CORRECCIÓN ▼▼▼
                // En lugar de buscar en todo el documento, buscamos la cabecera a partir del body de la tabla. Es más seguro.
                const tableHead = historyBody.previousElementSibling;
                if (tableHead && tableHead.tagName === 'THEAD') {
                    tableHead.innerHTML = `
                <tr>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo de Trabajo</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Detalles</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Técnico Asignado</th>
                    <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado Final</th>
                </tr>
            `;
                }

                data.forEach(item => {
                    const tr = document.createElement('tr');
                    const estado = item.estado || 'N/A';
                    tr.className = { 'Operativo': 'status-operativo', 'Inoperativo': 'status-inoperativo', 'Pendiente': 'status-pendiente', 'Retirado': 'status-retirado' }[estado] || '';

                    const fecha = item.trabajos ? new Date(item.trabajos.fecha + 'T00:00:00').toLocaleDateString('es-ES') : 'N/A';
                    const tipoTrabajo = item.tipo_trabajo || 'N/A';
                    const detalleCompleto = [item.diag_ini, item.trab_realizado, item.resul].filter(Boolean).join(' / ');

                    const tecnico = item.trabajos.tecnicos;
                    let tecnicoInfoHTML = '<span class="text-xs text-gray-400">No asignado</span>';
                    if (tecnico && tecnico.cargo.toLowerCase() !== 'sala') {
                        tecnicoInfoHTML = `

                    <div class="font-medium text-gray-900">${tecnico.usuario}</div>
                    <div class="text-xs text-gray-500">${tecnico.correo || ''}</div>
                    <div class="text-xs text-gray-500">${tecnico.cel || ''}</div>
                `;
                    }

                    tr.innerHTML = `
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${fecha}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${tipoTrabajo}</td>
                <td class="px-4 py-4 text-sm text-gray-500">${detalleCompleto}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm">${tecnicoInfoHTML}</td>
                <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${estado}</td>
            `;
                    historyBody.appendChild(tr);
                });

            } catch (error) {
                console.error('Error detallado al cargar historial:', error);
                const historyBody = document.getElementById('incidencia-history-body');
                if (historyBody) {
                    historyBody.innerHTML = `<tr><td colspan="5" class="px-4 py-4 text-center text-red-500">Error al cargar el historial. Revisa la consola.</td></tr>`;
                }
            }
        }

        async function handleIncidenciaSubmit(event) {
            event.preventDefault();

            if (!selectedMachineId) {
                alert('Por favor, seleccione una máquina.');
                return;
            }

            const submitButton = event.target.querySelector('button[type="submit"]');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i data-lucide="loader-2" class="animate-spin w-4 h-4"></i> Enviando...';
            lucide.createIcons();


            const { fecha, hora } = getPeruDateTime(); // Llamamos a nuestra nueva función

            const trabajo = {
                id_sala: userSalaId,
                id_usuario: currentUser.id,
                fecha: fecha,
                hora_inicio: hora,
                hora_fin: hora

            };

            try {
                const { data: trabajoData, error: trabajoError } = await supabaseClient
                    .from('trabajos')
                    .insert(trabajo)
                    .select()
                    .single();

                if (trabajoError) throw trabajoError;

                // ▼▼▼ MODIFICADO: Usar valores por defecto para los campos ocultos ▼▼▼
                const detalle = {
                    id_trabajo: trabajoData.id_trabajo,
                    id_maquina: selectedMachineId,
                    tipo_trabajo: 'Asistencia Remota', // Valor por defecto
                    diag_ini: incidenciaDiagTextarea.value,
                    estado: 'Inoperativo', // Valor por defecto
                };

                const { error: detalleError } = await supabaseClient.from('detalle').insert(detalle);
                if (detalleError) throw detalleError;

                alert('¡Incidencia reportada con éxito!');

                // La subscripción en tiempo real se encargará de actualizar la tabla si es necesario
                // No es necesario llamar a loadHistoryForMachine manualmente.

                incidenciaDiagTextarea.value = '';
                // Opcional: Deseleccionar la máquina y limpiar la tabla
                // document.querySelectorAll('.machine-button.selected').forEach(btn => btn.classList.remove('selected'));
                // selectedMachineId = null;
                // incidenciaHistoryBody.innerHTML = `<tr><td colspan="4" class="px-4 py-4 text-center text-gray-500">Seleccione una máquina para ver su historial.</td></tr>`;

            } catch (error) {
                console.error('Error al reportar incidencia:', error);
                alert('Error al reportar la incidencia: ' + error.message);
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i data-lucide="send" class="w-4 h-4"></i> Enviar Reporte';
                lucide.createIcons();
            }
        }

        // ▼▼▼ AGREGA ESTAS 3 NUEVAS FUNCIONES ▼▼▼

        // Función principal que se activa al hacer clic en una sala
        async function showDetailsForSala(salaName) {
            const container = document.getElementById('sala-details-container');
            const tableDiv = document.getElementById('sala-details-table');
            const title = document.getElementById('sala-details-title');

            title.textContent = `Detalle de Máquinas Atendidas en: ${salaName}`;
            tableDiv.innerHTML = '<p class="text-center text-gray-500">Cargando detalles...</p>';
            container.classList.remove('hidden'); // Muestra el contenedor

            // 1. Llama a la función para buscar los datos en Supabase
            const detailsData = await fetchDetailsForSala(salaName);

            // 2. Llama a la función para construir la tabla con los datos
            renderSalaDetailsTable(detailsData);
        }

        // Función para obtener los datos de la BD
        async function fetchDetailsForSala(salaName) {
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;

            const { data, error } = await supabaseClient
                .from('detalle')
                .select(`
                    trabajos!inner(fecha, sala!inner(sala_mincetur)),
                    maquinas!inner(serie, gabinete),
                    estado, tipo_trabajo, diag_ini, trab_realizado, resul
                `)
                .eq('trabajos.sala.sala_mincetur', salaName)
                .gte('trabajos.fecha', startDate)
                .lte('trabajos.fecha', endDate)
                .order('fecha', { foreignTable: 'trabajos', ascending: false });

            if (error) {
                console.error("Error fetching details for sala:", error);
                return [];
            }
            return data;
        }
        // ▼▼▼ AGREGA ESTA FUNCIÓN NUEVA ▼▼▼
        /**
         * Genera un arreglo de colores en degradado de azul.
         * @param {number} count - El número de colores a generar.
         * @returns {string[]} Un arreglo de colores en formato 'rgba()'.
         */
        function generateBlueGradient(count) {
            const colors = [];
            // Definimos el color inicial (oscuro) y final (claro) en RGB
            const startColor = { r: 37, g: 99, b: 235 };  // Azul oscuro
            const endColor = { r: 191, g: 219, b: 254 }; // Azul claro

            for (let i = 0; i < count; i++) {
                const ratio = i / (count - 1);
                const r = Math.round(startColor.r + ratio * (endColor.r - startColor.r));
                const g = Math.round(startColor.g + ratio * (endColor.g - startColor.g));
                const b = Math.round(startColor.b + ratio * (endColor.b - startColor.b));
                colors.push(`rgba(${r}, ${g}, ${b}, 0.8)`);
            }
            return colors;
        }

        // Función para construir el HTML de la tabla
        function renderSalaDetailsTable(data) {
            const tableDiv = document.getElementById('sala-details-table');
            if (!data || data.length === 0) {
                tableDiv.innerHTML = '<p class="text-center text-gray-500">No se encontraron registros para esta sala en el rango de fechas seleccionado.</p>';
                return;
            }

            let tableHTML = `
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="table-header">
                        <tr>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Serie</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Gabinete</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Tipo de Trabajo</th>
                            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado Final</th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
            `;

            data.forEach(item => {
                const fecha = new Date(item.trabajos.fecha + 'T00:00:00').toLocaleDateString('es-ES');
                const serie = item.maquinas?.serie || 'N/A';
                const gabinete = item.maquinas?.gabinete || 'N/A';
                const tipoTrabajo = item.tipo_trabajo || 'N/A';
                const estado = item.estado || 'N/A';

                const detallesCompletos = [
                    item.diag_ini ? `<b>Diagnóstico:</b> ${item.diag_ini}` : '',
                    item.trab_realizado ? `<b>Trabajo:</b> ${item.trab_realizado}` : '',
                    item.resul ? `<b>Resultado:</b> ${item.resul}` : ''
                ].filter(Boolean).join('<br>');

                // ▼▼▼ 1. OBTENEMOS LA CLASE DEL ESTADO (Igual que en las otras tablas) ▼▼▼
                const statusClass = {
                    'Operativo': 'status-operativo',
                    'Inoperativo': 'status-inoperativo',
                    'Pendiente': 'status-pendiente',
                    'Retirado': 'status-retirado'
                }[estado] || '';

                // ▼▼▼ 2. APLICAMOS LA CLASE A LA FILA <tr> ▼▼▼
                tableHTML += `
                    <tr class="${statusClass}">
                        <td class="px-4 py-4 whitespace-nowrap text-sm">${fecha}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">${serie}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">${gabinete}</td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">
                            <div class="tooltip-container">
                                ${tipoTrabajo}
                                <div class="tooltip-bubble">${detallesCompletos || 'Sin detalles.'}</div>
                            </div>
                        </td>
                        <td class="px-4 py-4 whitespace-nowrap text-sm">
                            <div class="tooltip-container">
                                ${estado}
                                <div class="tooltip-bubble">${detallesCompletos || 'Sin detalles.'}</div>
                            </div>
                        </td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            tableDiv.innerHTML = tableHTML;
        }


        // =================================================================
        // --- ADMIN VIEW LOGIC (SIN CAMBIOS) ---
        // =================================================================
        async function initializeAdminView() {
            maquinasDashboard.classList.remove('hidden');
            filtersSection.style.display = 'flex';
            function switchView(view) {
                [maquinasDashboard, tecnicosDashboard, reporteDashboard].forEach(d => d.classList.add('hidden'));
                [gabineteFilterContainer, tecnicoFilterContainer, departamentoFilterContainer, salaFilterContainer, workTypeFilterContainer].forEach(f => f.style.display = 'none');
                document.querySelectorAll('#main-nav .nav-button').forEach(b => b.classList.remove('active'));

                if (view === 'maquinas') {
                    navMaquinasBtn.classList.add('active');
                    maquinasDashboard.classList.remove('hidden');
                    gabineteFilterContainer.style.display = 'block';
                } else if (view === 'tecnicos') {
                    navTecnicosBtn.classList.add('active');
                    tecnicosDashboard.classList.remove('hidden');
                    tecnicoFilterContainer.style.display = 'block';
                } else if (view === 'reporte') {
                    navReporteBtn.classList.add('active');
                    reporteDashboard.classList.remove('hidden');
                    departamentoFilterContainer.style.display = 'block';
                    salaFilterContainer.style.display = 'block';
                    workTypeFilterContainer.style.display = 'block';
                }
                applyFilters();
            }
            navMaquinasBtn.addEventListener('click', () => switchView('maquinas'));
            navTecnicosBtn.addEventListener('click', () => switchView('tecnicos'));
            navReporteBtn.addEventListener('click', () => switchView('reporte'));
            setDefaultDates();
            loadingText.textContent = 'Cargando filtros...';
            await Promise.all([
                populateGabineteFilter(),
                populateTechnicianFilter(),
                populateDepartamentoFilter(),
                populateSalaFilter(),
                populateWorkTypeFilter()
            ]);

            await applyFilters();
            applyFiltersBtn.addEventListener('click', applyFilters);

            tecnicoFilterBtn.addEventListener('click', () => tecnicoFilterOptions.classList.toggle('hidden'));
            departamentoFilterBtn.addEventListener('click', () => departamentoFilterOptions.classList.toggle('hidden'));
            salaFilterBtn.addEventListener('click', () => salaFilterOptions.classList.toggle('hidden'));
            workTypeFilterBtn.addEventListener('click', () => workTypeFilterOptions.classList.toggle('hidden'));

            tecnicoFilterOptions.addEventListener('change', updateTechnicianFilterText);
            departamentoFilterOptions.addEventListener('change', updateDepartamentoFilterText);
            salaFilterOptions.addEventListener('change', updateSalaFilterText);
            workTypeFilterOptions.addEventListener('change', updateWorkTypeFilterText);

            document.addEventListener('click', (e) => {
                if (!tecnicoFilterContainer.contains(e.target)) tecnicoFilterOptions.classList.add('hidden');
                if (!departamentoFilterContainer.contains(e.target)) departamentoFilterOptions.classList.add('hidden');
                if (!salaFilterContainer.contains(e.target)) salaFilterOptions.classList.add('hidden');
                if (!workTypeFilterContainer.contains(e.target)) workTypeFilterOptions.classList.add('hidden');
            });
            document.getElementById('card-inoperativas').addEventListener('click', () => showDetailsModal('Inoperativo'));
            document.getElementById('card-pendientes').addEventListener('click', () => showDetailsModal('Pendiente'));
            modalCloseBtn.addEventListener('click', () => detailsModal.style.display = 'none');
            window.addEventListener('click', (event) => { if (event.target == detailsModal) { detailsModal.style.display = 'none'; } });
            setupRealtimeSubscription(() => {
                console.log("Realtime update triggered for Admin view. Re-applying filters.");
                applyFilters();
            });
        }

        async function applyFilters() {
            loadingOverlay.style.display = 'flex';
            loadingOverlay.style.opacity = '1';
            loadingText.textContent = 'Cargando datos...';
            const startDate = startDateInput.value;
            const endDate = endDateInput.value;
            const activeDashboard = document.querySelector('.nav-button.active').id;
            try {
                if (activeDashboard === 'nav-maquinas') {
                    const typeFilter = typeFilterInput.value;
                    const [machineStatesData, topSalasData, topTrabajosData] = await Promise.all([
                        fetchMachineStates(startDate, endDate, typeFilter),
                        fetchTopSalas(startDate, endDate, typeFilter),
                        fetchTopTrabajos(startDate, endDate, typeFilter)
                    ]);
                    currentMachineStates = machineStatesData;
                    updateMachineStatesUI(machineStatesData);
                    updateTopSalasUI(topSalasData);
                    updateTopTrabajosUI(topTrabajosData);
                } else if (activeDashboard === 'nav-tecnicos') {
                    const technicianIds = getSelectedIds('.technician-checkbox:checked');
                    const params = { start_date: startDate, end_date: endDate, technician_ids_filter: technicianIds.length > 0 ? technicianIds : null };
                    const [hoursData, avgTimeData, visitsData] = await Promise.all([
                        supabaseClient.rpc('get_hours_by_technician', params),
                        supabaseClient.rpc('get_avg_time_by_work_type', params),
                        supabaseClient.rpc('get_visits_by_technician', params)
                    ]);
                    if (hoursData.error) throw hoursData.error;
                    if (avgTimeData.error) throw avgTimeData.error;
                    if (visitsData.error) throw visitsData.error;
                    updateTechniciansUI(hoursData.data, avgTimeData.data, visitsData.data);
                } else if (activeDashboard === 'nav-reporte') {
                    const depts = getSelectedIds('.departamento-checkbox:checked');
                    const salas = getSelectedIds('.sala-checkbox:checked');
                    const workTypes = getSelectedIds('.work-type-checkbox:checked');
                    const reportData = await fetchReportData(startDate, endDate, depts, salas, workTypes);
                    updateReportTableUI(reportData);
                }
            } catch (error) {
                console.error('Error al aplicar filtros:', error);
                alert(`Error al cargar datos: ${error.message}`);
            } finally {
                loadingOverlay.style.opacity = '0';
                setTimeout(() => loadingOverlay.style.display = 'none', 300);
            }
        }

        function setDefaultDates() {
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);
            endDateInput.value = today.toISOString().split('T')[0];
            startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
        }
        function createMultiSelect(options) {
            const { container, items, idField, nameField, checkboxClass, allSelectorId, updateTextFn } = options;
            container.innerHTML = '';

            const allOptionLabel = document.createElement('label');
            allOptionLabel.className = 'flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer font-semibold';
            allOptionLabel.innerHTML = `<input type="checkbox" id="${allSelectorId}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-3"> Todos`;
            container.appendChild(allOptionLabel);
            items.forEach(item => {
                const label = document.createElement('label');
                label.className = 'flex items-center px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 cursor-pointer';
                const id = item[idField];
                const name = item[nameField];
                label.innerHTML = `<input type="checkbox" data-id="${id}" class="h-4 w-4 rounded border-gray-300 text-indigo-600 focus:ring-indigo-500 mr-3 ${checkboxClass}"> ${name}`;
                container.appendChild(label);
            });

            document.getElementById(allSelectorId).addEventListener('change', (e) => {
                container.querySelectorAll(`.${checkboxClass}`).forEach(cb => cb.checked = e.target.checked);
                updateTextFn();
            });
        }

        async function populateGabineteFilter() {
            const { data, error } = await supabaseClient.from('maquinas').select('gabinete');
            if (error) { console.error('Error fetching gabinetes:', error); return; }
            const distinctGabinetes = [...new Set(data.map(item => item.gabinete).filter(Boolean))].sort();
            typeFilterInput.innerHTML = '<option>Todos</option>';
            distinctGabinetes.forEach(gabinete => {
                const option = document.createElement('option');
                option.value = gabinete;
                option.textContent = gabinete;
                typeFilterInput.appendChild(option);
            });
        }
        async function populateTechnicianFilter() {
            const { data, error } = await supabaseClient.from('tecnicos').select('id_usuario, usuario').order('usuario');
            if (error) { console.error('Error fetching technicians:', error); return; }
            allTechnicians = data;
            createMultiSelect({
                container: tecnicoFilterOptions, items: allTechnicians, idField: 'id_usuario', nameField: 'usuario',
                checkboxClass: 'technician-checkbox', allSelectorId: 'select-all-technicians', updateTextFn: updateTechnicianFilterText
            });
        }

        async function populateDepartamentoFilter() {
            const { data, error } = await supabaseClient.from('sala').select('departamento');
            if (error) { console.error('Error fetching departamentos:', error); return; }
            allDepartamentos = [...new Set(data.map(item => item.departamento).filter(Boolean))].sort().map(d => ({ departamento: d }));
            createMultiSelect({
                container: departamentoFilterOptions, items: allDepartamentos, idField: 'departamento', nameField: 'departamento',
                checkboxClass: 'departamento-checkbox', allSelectorId: 'select-all-departamentos', updateTextFn: updateDepartamentoFilterText
            });
        }
        async function populateSalaFilter() {
            const { data, error } = await supabaseClient.from('sala').select('id_sala, sala_mincetur').order('sala_mincetur');
            if (error) { console.error('Error fetching salas:', error); return; }
            allSalas = data;
            createMultiSelect({
                container: salaFilterOptions, items: allSalas, idField: 'id_sala', nameField: 'sala_mincetur',
                checkboxClass: 'sala-checkbox', allSelectorId: 'select-all-salas', updateTextFn: updateSalaFilterText
            });
        }
        async function populateWorkTypeFilter() {
            const { data, error } = await supabaseClient.from('detalle').select('tipo_trabajo');
            if (error) { console.error('Error fetching work types:', error); return; }
            allWorkTypes = [...new Set(data.map(item => item.tipo_trabajo).filter(Boolean))].sort().map(wt => ({ tipo_trabajo: wt }));
            createMultiSelect({
                container: workTypeFilterOptions, items: allWorkTypes, idField: 'tipo_trabajo', nameField: 'tipo_trabajo',
                checkboxClass: 'work-type-checkbox', allSelectorId: 'select-all-work-types', updateTextFn: updateWorkTypeFilterText
            });
        }

        const getSelectedIds = (selector) => Array.from(document.querySelectorAll(`${selector}`)).map(cb => cb.dataset.id);
        const updateMultiSelectText = (textEl, count, total, singleText, pluralText, allText) => {
            if (count === 0 || count === total) { textEl.textContent = allText; }
            else if (count === 1) {
                const selectedCheckbox = document.querySelector(`.${pluralText.slice(0, -1)}-checkbox:checked`);
                textEl.textContent = selectedCheckbox ? selectedCheckbox.parentElement.textContent.trim() : `1 ${singleText} seleccionado`;
            } else { textEl.textContent = `${count} ${pluralText} seleccionados`; }
        };
        const updateTechnicianFilterText = () => updateMultiSelectText(tecnicoFilterText, getSelectedIds('.technician-checkbox:checked').length, allTechnicians.length, 'técnico', 'técnicos', 'Todos los técnicos');
        const updateDepartamentoFilterText = () => updateMultiSelectText(departamentoFilterText, getSelectedIds('.departamento-checkbox:checked').length, allDepartamentos.length, 'dpto.', 'dptos.', 'Todos los departamentos');
        const updateSalaFilterText = () => updateMultiSelectText(salaFilterText, getSelectedIds('.sala-checkbox:checked').length, allSalas.length, 'sala', 'salas', 'Todas las salas');
        const updateWorkTypeFilterText = () => updateMultiSelectText(workTypeFilterText, getSelectedIds('.work-type-checkbox:checked').length, allWorkTypes.length, 'tipo', 'tipos', 'Todos los tipos');
        async function fetchTopSalas(startDate, endDate, typeFilter) {
            let query = supabaseClient.from('trabajos').select('id_sala, detalle!inner(maquinas!inner(gabinete))').gte('fecha', startDate).lte('fecha', endDate);
            if (typeFilter !== 'Todos') { query = query.eq('detalle.maquinas.gabinete', typeFilter); }
            const { data: trabajosData, error: trabajosError } = await query;
            if (trabajosError) throw trabajosError;
            if (!trabajosData || trabajosData.length === 0) return [];
            const salaIds = [...new Set(trabajosData.map(t => t.id_sala).filter(id => id != null))];
            if (salaIds.length === 0) return [];
            const { data: salasData, error: salasError } = await supabaseClient.from('sala').select('id_sala, sala_mincetur').in('id_sala', salaIds);
            if (salasError) throw salasError;
            const salaVisits = trabajosData.reduce((acc, trabajo) => { if (trabajo.id_sala) { acc[trabajo.id_sala] = (acc[trabajo.id_sala] || 0) + 1; } return acc; }, {});
            const salaMap = salasData.reduce((acc, sala) => { acc[sala.id_sala] = sala.sala_mincetur; return acc; }, {});
            return Object.entries(salaVisits).map(([id_sala, visitas]) => ({ nombre_sala: salaMap[id_sala] || `Sala ID ${id_sala}`, visitas: visitas })).sort((a, b) => b.visitas - a.visitas).slice(0, 15);
        }
        async function fetchMachineStates(startDate, endDate, typeFilter) {
            const { data: trabajosData, error: trabajosError } = await supabaseClient.from('trabajos').select('id_trabajo, fecha, hora_fin, id_sala').gte('fecha', startDate).lte('fecha', endDate);
            if (trabajosError) throw trabajosError; if (!trabajosData || trabajosData.length === 0) return [];
            const trabajoIds = trabajosData.map(t => t.id_trabajo);
            const { data: detailsData, error: detailsError } = await supabaseClient.from('detalle').select('id_trabajo, id_maquina, estado, tipo_trabajo, diag_ini, trab_realizado, resul').in('id_trabajo', trabajoIds).not('id_maquina', 'is', null);
            if (detailsError) throw detailsError; if (!detailsData || detailsData.length === 0) return [];
            const trabajoInfoMap = trabajosData.reduce((acc, t) => { acc[t.id_trabajo] = { date: new Date(`${t.fecha}T${t.hora_fin || '00:00:00'}`), id_sala: t.id_sala }; return acc; }, {});
            const latestDetails = {};
            for (const detail of detailsData) {
                const machineId = detail.id_maquina;
                const trabajoInfo = trabajoInfoMap[detail.id_trabajo];
                if (!trabajoInfo) continue;
                if (!latestDetails[machineId] || trabajoInfo.date > latestDetails[machineId].date) {
                    const fullDescription = [detail.diag_ini, detail.trab_realizado, detail.resul].filter(Boolean).join(' / ');
                    latestDetails[machineId] = { estado: detail.estado, id_maquina: machineId, date: trabajoInfo.date, id_sala: trabajoInfo.id_sala, motivo: detail.tipo_trabajo, descripcion: fullDescription };
                }
            }
            const machineIds = Object.keys(latestDetails); if (machineIds.length === 0) return [];
            const salaIds = [...new Set(Object.values(latestDetails).map(d => d.id_sala).filter(id => id != null))];
            let salaMap = {};
            if (salaIds.length > 0) {
                const { data: salasData, error: salasError } = await supabaseClient.from('sala').select('id_sala, sala_mincetur').in('id_sala', salaIds);
                if (salasError) throw salasError;
                salaMap = salasData.reduce((acc, sala) => { acc[sala.id_sala] = sala.sala_mincetur; return acc; }, {});
            }
            let query = supabaseClient.from('maquinas').select('id_maquina, serie, modelo, gabinete').in('id_maquina', machineIds);
            if (typeFilter !== 'Todos') { query = query.eq('gabinete', typeFilter); }
            const { data: maquinasData, error: maquinasError } = await query;
            if (maquinasError) throw maquinasError;
            return maquinasData.map(machine => { const details = latestDetails[machine.id_maquina]; return { serie: machine.serie, modelo: machine.modelo, gabinete: machine.gabinete, estado: details.estado, fecha: details.date, sala: salaMap[details.id_sala] || 'Sala desconocida', motivo: details.motivo, descripcion: details.descripcion }; });
        }

        async function fetchTopTrabajos(startDate, endDate, typeFilter) {
            let query = supabaseClient.from('trabajos').select('detalle!inner(tipo_trabajo, maquinas!inner(gabinete))').gte('fecha', startDate).lte('fecha', endDate);
            if (typeFilter !== 'Todos') { query = query.eq('detalle.maquinas.gabinete', typeFilter); }
            const { data, error } = await query;
            if (error) throw error;
            if (!data) return [];
            const workTypeCounts = data.reduce((acc, trabajo) => {
                trabajo.detalle.forEach(d => {
                    if (d.tipo_trabajo) { acc[d.tipo_trabajo] = (acc[d.tipo_trabajo] || 0) + 1; }
                });
                return acc;
            }, {});
            return Object.entries(workTypeCounts).map(([tipo, count]) => ({ tipo, count })).sort((a, b) => b.count - a.count).slice(0, 5);
        }
        async function fetchReportData(startDate, endDate, departamentos, salas, workTypes) {
            let query = supabaseClient
                .from('detalle')
                .select(`
                    estado, diag_ini, trab_realizado, resul, tipo_trabajo,
                    maquinas!inner (serie, modelo, gabinete),
                    trabajos!inner (
                        fecha, 
                        tecnicos(usuario, correo, cel, cargo),
                        sala!inner(sala_mincetur, empresa, departamento, provincia, distrito)
                    )
                `)
                .gte('trabajos.fecha', startDate)
                .lte('trabajos.fecha', endDate);
            if (departamentos.length > 0) query = query.in('trabajos.sala.departamento', departamentos);
            if (salas.length > 0) query = query.in('trabajos.sala.id_sala', salas);
            if (workTypes.length > 0) query = query.in('tipo_trabajo', workTypes);
            query = query.order('fecha', { foreignTable: 'trabajos', ascending: false });
            const { data, error } = await query;
            if (error) { console.error("Error fetching report data:", error); throw error; }
            return data;
        }
        function updateMachineStatesUI(data) {
            document.getElementById('total-maquinas').textContent = data.length;
            document.getElementById('total-operativas').textContent = data.filter(m => m.estado === 'Operativo').length;
            document.getElementById('total-inoperativas').textContent = data.filter(m => m.estado === 'Inoperativo').length;
            document.getElementById('total-pendientes').textContent = data.filter(m => m.estado === 'Pendiente').length;
        }
        function updateTopSalasUI(data) {
            const labels = data.map(s => s.nombre_sala);
            const visitas = data.map(s => s.visitas);
            const ctx = document.getElementById('topSalasChart').getContext('2d');
            if (topSalasChartInstance) topSalasChartInstance.destroy();

            // ▼▼▼ 1. LLAMAMOS A LA NUEVA FUNCIÓN PARA CREAR EL DEGRADADO ▼▼▼
            const gradientColors = generateBlueGradient(data.length);

            topSalasChartInstance = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Número de Visitas',
                        data: visitas,
                        // ▼▼▼ 2. USAMOS LOS COLORES GENERADOS ▼▼▼
                        backgroundColor: gradientColors
                    }]
                },
                options: {
                    indexAxis: 'y',
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false },
                        datalabels: { anchor: 'end', align: 'end', color: '#1f2937', font: { weight: 'bold' } }
                    },
                    scales: { x: { beginAtZero: true } },
                    onHover: (event, chartElement) => {
                        event.native.target.style.cursor = chartElement[0] ? 'pointer' : 'default';
                    },
                    onClick: (event) => {
                        const points = topSalasChartInstance.getElementsAtEventForMode(event, 'nearest', { intersect: true }, true);
                        if (points.length) {
                            const firstPoint = points[0];
                            const label = topSalasChartInstance.data.labels[firstPoint.index];
                            showDetailsForSala(label);
                        }
                    }
                }
            });
        }
        function updateTopTrabajosUI(data) {
            const labels = data.map(d => d.tipo);
            const counts = data.map(d => d.count);
            const ctx = document.getElementById('topTrabajosChart').getContext('2d');
            if (topTrabajosChartInstance) topTrabajosChartInstance.destroy();
            topTrabajosChartInstance = new Chart(ctx, { type: 'bar', data: { labels, datasets: [{ label: 'Cantidad de Trabajos', data: counts, backgroundColor: colorPalette.slice().reverse() }] }, options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, datalabels: { anchor: 'center', align: 'center', color: 'white', font: { weight: 'bold' } } }, scales: { x: { beginAtZero: true } } } });
        }
        function updateReportTableUI(data) {
            const table = document.getElementById('admin-report-table');
            if (!table) {
                console.error("No se encontró la tabla de reportes del admin.");
                return;
            }
            const tableHead = table.querySelector('thead');
            const tableBody = table.querySelector('tbody');

            // 1. LIMPIAMOS LA TABLA UNA SOLA VEZ, ANTES DE EMPEZAR
            tableHead.innerHTML = '';


            // 2. CREAMOS LA CABECERA UNA SOLA VEZ
            tableHead.innerHTML = `
        <tr>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Fecha</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Slot/Ruleta</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Serie</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Sala</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Incidencia</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Técnico Asignado</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Estado</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Razón Social</th>
            <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase">Ubicación</th>
        </tr>
    `;

            if (!data || data.length === 0) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center text-gray-500 py-4">No se encontraron datos para los filtros seleccionados.</td></tr>`;
                return;
            }

            const latestRecords = Object.values(data.reduce((acc, record) => {
                const serie = record.maquinas?.serie;
                if (serie) {
                    if (!acc[serie] || new Date(record.trabajos.fecha) > new Date(acc[serie].trabajos.fecha)) {
                        acc[serie] = record;
                    }
                }
                return acc;
            }, {}));

            latestRecords.sort((a, b) => new Date(b.trabajos.fecha) - new Date(a.trabajos.fecha));

            // 3. AHORA SÍ, RECORREMOS LOS REGISTROS Y CREAMOS LAS FILAS
            latestRecords.forEach(item => {
                const tr = document.createElement('tr');
                const estado = item.estado || 'N/A';
                tr.className = { 'Operativo': 'status-operativo', 'Inoperativo': 'status-inoperativo', 'Pendiente': 'status-pendiente' }[estado] || '';

                const fecha = new Date(item.trabajos.fecha + 'T00:00:00').toLocaleDateString('es-ES', { day: '2-digit', month: 'short' }).replace('.', '');
                const modeloGabinete = [item.maquinas?.modelo, item.maquinas?.gabinete].filter(Boolean).join(' / ');
                const serie = item.maquinas?.serie || 'N/A';
                const sala = item.trabajos.sala?.sala_mincetur || 'N/A';
                const tipoTrabajo = item.tipo_trabajo || 'No especificado';
                const detalleCompleto = [item.diag_ini, item.trab_realizado, item.resul].filter(Boolean).join(' <br> ');
                const incidenciaHTML = `<div class="tooltip-container">${tipoTrabajo}<div class="tooltip-bubble">${detalleCompleto || 'Sin detalles.'}</div></div>`;


                const razonSocial = item.trabajos.sala?.empresa || 'N/A';
                const ubicacion = [item.trabajos.sala?.departamento, item.trabajos.sala?.provincia, item.trabajos.sala?.distrito].filter(Boolean).join(', ');

                // ▼▼▼ ESTA ES LA LÓGICA CORREGIDA Y MÁS SEGURA ▼▼▼
                const tecnico = item.trabajos.tecnicos;
                let tecnicoAsignadoHTML = '<span class="text-xs text-gray-400">No asignado</span>';

                // Verificamos que 'tecnico' y 'tecnico.cargo' existan ANTES de usarlos
                if (tecnico && tecnico.cargo) {
                    if (tecnico.cargo.toLowerCase() !== 'sala') {
                        tecnicoAsignadoHTML = `
                    <div class="font-medium text-gray-900">${tecnico.usuario}</div>
                    <div class="text-xs text-gray-500">${tecnico.correo || ''}</div>
                    <div class="text-xs text-gray-500">${tecnico.cel || ''}</div>
                `;
                    }
                } 

                tr.innerHTML = `
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-900">${fecha}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${modeloGabinete}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${serie}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${sala}</td>
            <td class="px-4 py-4 text-sm text-gray-500">${incidenciaHTML}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm">${tecnicoAsignadoHTML}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${estado}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${razonSocial}</td>
            <td class="px-4 py-4 whitespace-nowrap text-sm text-gray-500">${ubicacion}</td>
        `;
                tableBody.appendChild(tr);
            });
        }
        // --- STARTUP ---
        document.addEventListener('DOMContentLoaded', checkSession);
    </script>
</body>

</html>

