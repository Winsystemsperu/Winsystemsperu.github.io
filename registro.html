<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Registro Producción - Winsystems</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>

    <style>
        input[readonly] { background-color: #f9fafb; cursor: not-allowed; color: #6b7280; }
        .hidden-force { display: none !important; }
        .custom-scroll::-webkit-scrollbar { width: 8px; }
        .custom-scroll::-webkit-scrollbar-track { background: #f1f1f1; }
        .custom-scroll::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        .img-contain { object-fit: contain; width: 100%; height: 100%; }
        .scan-success { animation: flash 0.5s; }
        @keyframes flash { 0% { background-color: #86efac; } 100% { background-color: white; } }
    </style>
</head>
<body class="bg-slate-50 text-gray-800 font-sans pb-24">

    <div id="loading-overlay" class="fixed inset-0 bg-white/90 z-[9999] flex flex-col items-center justify-center hidden-force">
        <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-600 mb-3"></div>
        <p class="font-medium text-gray-600 animate-pulse">Procesando...</p>
    </div>

    <div id="modal-scanner" class="fixed inset-0 bg-black/95 z-[100] flex flex-col items-center justify-center hidden-force">
        <div class="w-full max-w-md relative bg-black border border-gray-700 rounded-lg overflow-hidden">
            <div class="p-4 flex justify-between items-center text-white bg-gray-900">
                <h3 class="font-bold flex items-center gap-2">Escáner</h3>
                <button onclick="stopCamera()" class="p-2 hover:bg-gray-700 rounded-full">X</button>
            </div>
            <div id="reader" class="w-full h-72 bg-black"></div>
        </div>
    </div>

    <div id="modal-catalog" class="fixed inset-0 bg-black/60 z-50 flex items-center justify-center hidden-force backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-5xl h-[85vh] flex flex-col mx-4 overflow-hidden">
            <div class="p-4 border-b flex justify-between items-center bg-gray-50">
                <h3 class="text-lg font-bold">Catálogo de Repuestos</h3>
                <button onclick="toggleModal('modal-catalog')" class="text-gray-500 hover:text-red-500"><i data-lucide="x"></i></button>
            </div>
            <div class="p-4 border-b bg-white flex gap-3">
                <input type="text" id="catalog-search" class="w-full pl-4 p-2.5 border rounded-lg outline-none focus:ring-2 focus:ring-blue-500" placeholder="Buscar repuesto..." autofocus>
                <button onclick="toggleModal('modal-new-part')" class="bg-green-600 text-white px-4 rounded-lg shadow whitespace-nowrap">Nuevo</button>
            </div>
            <div class="flex-1 overflow-y-auto p-4 bg-slate-50 custom-scroll" id="catalog-grid">
                <p class="text-center py-10 text-gray-400">Cargando...</p>
            </div>
        </div>
    </div>

    <div id="modal-new-part" class="fixed inset-0 bg-black/50 z-[60] flex items-center justify-center hidden-force backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md mx-4">
            <div class="flex justify-between mb-4">
                <h3 class="text-lg font-bold">Nuevo Repuesto</h3>
                <button onclick="toggleModal('modal-new-part')" class="text-gray-400"><i data-lucide="x"></i></button>
            </div>
            <form id="form-new-part" class="space-y-4">
                <input type="text" id="new-nombre" class="w-full p-2 border rounded" placeholder="Nombre" required>
                <input type="text" id="new-pn" class="w-full p-2 border rounded" placeholder="P/N">
                <select id="new-categoria" class="w-full p-2 border rounded bg-white"><option>General</option><option>Ruleta</option><option>Slot</option><option>Sistemas</option></select>
                <input type="url" id="new-img" class="w-full p-2 border rounded" placeholder="URL Imagen (opcional)">
                <button type="submit" class="w-full bg-green-600 text-white font-bold py-2 rounded">Guardar</button>
            </form>
        </div>
    </div>

    <div id="modal-edit-record" class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center hidden-force backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-lg mx-4">
            <div class="flex justify-between mb-4">
                <h3 class="text-lg font-bold">Editar Registro</h3>
                <button onclick="toggleModal('modal-edit-record')" class="text-gray-400"><i data-lucide="x"></i></button>
            </div>
            <form id="form-edit-record" class="space-y-4">
                <input type="hidden" id="edit-id">
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold">Serie</label><input type="text" id="edit-serie" class="w-full p-2 border rounded"></div>
                    <div><label class="text-xs font-bold">Cant.</label><input type="number" id="edit-cantidad" class="w-full p-2 border rounded"></div>
                </div>
                <div><label class="text-xs font-bold">Tipo</label><select id="edit-tipo" class="w-full p-2 border rounded bg-white"><option>General</option><option>Ruleta</option><option>Slot</option><option>Sistemas</option></select></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="text-xs font-bold">Registró</label><select id="edit-tecnico-1" class="w-full p-2 border rounded"></select></div>
                    <div><label class="text-xs font-bold">Visto Bueno</label><select id="edit-tecnico-2" class="w-full p-2 border rounded"></select></div>
                </div>
                <div><label class="text-xs font-bold">Obs</label><input type="text" id="edit-obs" class="w-full p-2 border rounded"></div>
                <button type="submit" class="w-full bg-blue-600 text-white font-bold py-2 rounded">Guardar Cambios</button>
            </form>
        </div>
    </div>

    <div class="max-w-6xl mx-auto p-4 md:p-8">
        
        <div class="flex flex-wrap items-center justify-between mb-6 gap-4">
            <div class="flex items-center gap-4">
                <img src="https://winsystems.com.pe/wp-content/uploads/2022/01/logo-winsystems-2022.png" alt="Logo" class="h-10 md:h-12">
                <div>
                    <h1 class="text-2xl font-bold text-gray-900 tracking-tight">Registro de Ingresos</h1>
                    <p class="text-sm text-gray-500 font-medium">Almacén - Producción</p>
                </div>
            </div>
            <div class="flex gap-2">
                <button onclick="exportToExcel()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg shadow-sm font-medium flex items-center gap-2 transition hover:scale-105">
                    <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Exportar Excel
                </button>
                <a href="index.html" class="text-blue-600 hover:text-blue-800 font-medium flex items-center gap-2 bg-white px-4 py-2 rounded-lg shadow-sm border transition hover:shadow-md">
                    <i data-lucide="arrow-left" class="w-4 h-4"></i> Salir
                </a>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-10">
            
            <div class="lg:col-span-2 bg-white rounded-xl shadow-lg p-6 border border-gray-100">
                <form id="registroForm" class="space-y-5">
                    
                    <div>
                        <label class="block text-sm font-bold text-gray-700 mb-2">Seleccionar Repuesto</label>
                        <div class="relative cursor-pointer group" onclick="openCatalogModal()">
                            <input type="text" id="display-repuesto" 
                                   class="w-full p-4 pl-12 border-2 border-blue-100 rounded-xl bg-blue-50/50 text-blue-900 font-semibold cursor-pointer group-hover:bg-blue-50 group-hover:border-blue-300 transition focus:outline-none placeholder-blue-300" 
                                   placeholder="Haga clic aquí para abrir el catálogo..." readonly>
                            <i data-lucide="search" class="absolute left-4 top-4 w-6 h-6 text-blue-500"></i>
                            <i data-lucide="chevron-down" class="absolute right-4 top-4 w-6 h-6 text-blue-400"></i>
                        </div>
                        <input type="hidden" id="reg-repuesto-id">
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Part Number (P/N)</label>
                            <input type="text" id="reg-pn" class="w-full p-2 bg-gray-50 border rounded text-gray-600 text-sm font-mono" readonly>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Tipo Máquina</label>
                            <select id="reg-tipo" class="w-full p-2 border border-gray-300 rounded-lg bg-white text-sm focus:ring-2 focus:ring-blue-500 cursor-pointer">
                                <option value="General">General</option><option value="Ruleta">Ruleta</option><option value="Slot">Slot</option><option value="Sistemas">Sistemas</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="relative">
                            <label class="block text-sm font-bold text-gray-700 mb-1">Serie</label>
                            <div class="flex">
                                <input type="text" id="reg-serie" class="w-full p-3 border border-gray-300 rounded-l-lg focus:ring-2 focus:ring-blue-500 uppercase font-mono shadow-sm" placeholder="SN..." required>
                                <button type="button" onclick="startCamera()" class="bg-blue-600 hover:bg-blue-700 text-white px-4 rounded-r-lg shadow-sm" title="Escanear con Cámara">
                                    <i data-lucide="camera" class="w-5 h-5"></i>
                                </button>
                            </div>
                        </div>
                        <div>
                            <label class="block text-sm font-bold text-gray-700 mb-1">Cantidad</label>
                            <input type="number" id="reg-cantidad" value="1" min="1" class="w-full p-3 border border-gray-300 rounded-lg shadow-sm">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4 bg-gray-50 p-4 rounded-lg border border-dashed border-gray-300">
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Registrado Por</label>
                            <select id="reg-tecnico-1" class="w-full p-2 border rounded text-sm bg-white shadow-sm" required><option value="">Cargando...</option></select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Visto Bueno (VB)</label>
                            <select id="reg-tecnico-2" class="w-full p-2 border border-green-200 rounded text-sm bg-green-50 text-green-800 font-medium shadow-sm" required><option value="">Cargando...</option></select>
                        </div>
                    </div>

                    <input type="hidden" id="reg-fecha">
                    <div class="mb-4">
                        <label class="block text-xs font-bold text-gray-700 uppercase mb-1">Ubicación Destino</label>
                        <input type="text" value="Almacen-Produccion" class="w-full p-2 bg-blue-50 border border-blue-200 rounded text-blue-800 font-bold text-center text-xs uppercase tracking-wide" readonly>
                    </div>

                    <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg flex justify-center items-center gap-2 transition transform active:scale-[0.98]">
                        <i data-lucide="save" class="w-5 h-5"></i> Registrar Ingreso
                    </button>
                </form>
            </div>

            <div class="space-y-6">
                <div class="bg-white rounded-xl shadow p-4 border border-gray-100 flex flex-col items-center justify-center h-full min-h-[300px] relative overflow-hidden group">
                    <p class="text-xs text-gray-400 absolute top-3 left-3 uppercase font-bold tracking-wider bg-white/80 px-2 py-1 rounded backdrop-blur-sm">Vista Previa</p>
                    <img id="img-preview" src="https://via.placeholder.com/300x200?text=Seleccione+Repuesto" 
                         class="img-contain rounded transition-transform duration-500 group-hover:scale-105 drop-shadow-xl" 
                         onerror="this.src='https://via.placeholder.com/300x200?text=Sin+Imagen'"
                         alt="Repuesto">
                </div>
            </div>
        </div>

        <div class="bg-white rounded-xl shadow-lg border border-gray-100 overflow-hidden">
            <div class="bg-gray-50 p-4 border-b border-gray-200 flex flex-wrap gap-4 justify-between items-center">
                <h2 class="text-lg font-bold text-gray-700 flex items-center gap-2"><i data-lucide="database" class="text-blue-600"></i> Inventario en Almacén-Producción</h2>
                <div class="relative w-full md:w-auto">
                    <i data-lucide="search" class="absolute left-3 top-2.5 w-4 h-4 text-gray-400"></i>
                    <input type="text" id="search-history" class="pl-9 pr-4 py-2 border rounded-lg text-sm w-full md:w-64 outline-none focus:ring-2 focus:ring-blue-500 bg-white" placeholder="Buscar en lista...">
                </div>
            </div>
            
            <div class="overflow-x-auto">
                <table class="w-full text-sm text-left text-gray-600" id="table-history">
                    <thead class="bg-gray-100 text-gray-700 uppercase text-xs font-bold">
                        <tr><th class="p-4">Fecha</th><th class="p-4">Repuesto</th><th class="p-4">Serie</th><th class="p-4">Tipo</th><th class="p-4">Registró</th><th class="p-4">Ubicación</th><th class="p-4 text-center">Acciones</th></tr>
                    </thead>
                    <tbody class="divide-y divide-gray-100 bg-white"><tr><td colspan="7" class="p-8 text-center text-gray-400 animate-pulse">Cargando registros...</td></tr></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // CONFIGURACIÓN SUPABASE
        const SUPABASE_URL = 'https://qobquktxvhlvtrpeopji.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFvYnF1a3R4dmhsdnRycGVvcGppIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDU2OTc4NDYsImV4cCI6MjA2MTI3Mzg0Nn0.rnubNUWSWEomj5Xwvr65kZLK7Ig_bLC74ajFh9cksFc';
        const STORAGE_BUCKET = 'repuestos'; 

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let listaRepuestosGlobal = [];
        let fullHistoryData = [];
        let html5QrCode;

        document.addEventListener('DOMContentLoaded', async () => {
            if(window.lucide) lucide.createIcons();
            setPeruTime();
            await loadData(); 
            await loadHistory();
            setInterval(setPeruTime, 60000); 

            document.getElementById('search-history').addEventListener('input', (e) => renderHistoryTable(e.target.value));
            document.getElementById('catalog-search').addEventListener('input', (e) => renderPartsGrid(e.target.value));
        });

        function setPeruTime() {
            const fecha = new Date();
            fecha.setHours(fecha.getHours() - 5); 
            document.getElementById('reg-fecha').value = fecha.toISOString(); 
        }

        // --- URL IMAGEN ---
        function getImgUrl(dbPath) {
            if (!dbPath) return "https://via.placeholder.com/150x150?text=Sin+Foto";
            if (dbPath.startsWith('http')) return dbPath;
            const encodedPath = dbPath.split('/').map(part => encodeURIComponent(part)).join('/');
            return `${SUPABASE_URL}/storage/v1/object/public/${STORAGE_BUCKET}/${encodedPath}`;
        }

        async function loadData() {
            try {
                // TÉCNICOS - CORREGIDO: usar 'usuario' en minúscula
                const { data: tecnicos, error: errTec } = await supabaseClient.from('tecnicos')
                    .select('usuario, cargo') // CORREGIDO
                    .ilike('cargo', '%Tecnico%')
                    .order('usuario', { ascending: true }); // CORREGIDO

                if (errTec) throw errTec;

                const htmlTec = tecnicos ? tecnicos.map(t => `<option value="${t.usuario}">${t.usuario}</option>`).join('') : '';
                document.getElementById('reg-tecnico-1').innerHTML = `<option value="">Seleccione...</option>` + htmlTec;
                document.getElementById('reg-tecnico-2').innerHTML = `<option value="">Seleccione...</option>` + htmlTec;
                document.getElementById('edit-tecnico-1').innerHTML = htmlTec;
                document.getElementById('edit-tecnico-2').innerHTML = htmlTec;

                // REPUESTOS
                await refreshRepuestosList();

            } catch (error) { 
                console.error("Error carga:", error);
            }
        }

        async function refreshRepuestosList() {
            const { data: repuestos } = await supabaseClient.from('repuestos').select('id_repuesto, nombre, num_part, imagen_url, categoria').order('nombre');
            if(repuestos) listaRepuestosGlobal = repuestos;
        }

        // --- CÁMARA (SCANNER) ---
        function startCamera() {
            document.getElementById('modal-scanner').classList.remove('hidden-force');
            html5QrCode = new Html5Qrcode("reader");
            
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrCode.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                alert("Error al abrir cámara: " + err + "\n(Requiere HTTPS o Localhost)");
                stopCamera();
            });
        }

        function onScanSuccess(decodedText) {
            stopCamera();
            const input = document.getElementById('reg-serie');
            input.value = decodedText;
            input.focus();
            input.classList.add('scan-success');
            setTimeout(() => input.classList.remove('scan-success'), 500);
        }

        function stopCamera() {
            if(html5QrCode) {
                html5QrCode.stop().then(() => {
                    html5QrCode.clear();
                    document.getElementById('modal-scanner').classList.add('hidden-force');
                }).catch(err => {
                    document.getElementById('modal-scanner').classList.add('hidden-force');
                });
            } else {
                document.getElementById('modal-scanner').classList.add('hidden-force');
            }
        }

        // --- CATALOGO ---
        function openCatalogModal() {
            toggleModal('modal-catalog');
            renderPartsGrid(''); 
            setTimeout(() => document.getElementById('catalog-search').focus(), 100);
        }

        function renderPartsGrid(filterText) {
            const container = document.getElementById('catalog-grid');
            container.innerHTML = '';
            const filter = filterText.toLowerCase();
            const filtered = listaRepuestosGlobal.filter(r => (r.nombre || r.Nombre || '').toLowerCase().includes(filter) || (r.num_part || r.Num_part || '').toLowerCase().includes(filter));

            if(filtered.length === 0) { container.innerHTML = `<div class="text-center py-10 text-gray-400 col-span-full">Sin resultados. <button onclick="toggleModal('modal-new-part')" class="text-blue-600 hover:underline">Crear Nuevo</button></div>`; return; }

            container.className = "grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 p-4 overflow-y-auto custom-scroll";

            filtered.forEach(item => {
                const nombre = item.Nombre || item.nombre;
                const pn = item.num_part || item.Num_part || 'S/N';
                const cat = item.Categoria || item.categoria || 'General';
                const imgSrc = getImgUrl(item.imagen_url || item.Imagen_url);
                
                const card = document.createElement('div');
                card.className = "bg-white border border-gray-200 rounded-lg p-3 cursor-pointer transition-all card-hover flex flex-col items-center text-center relative group";
                card.onclick = () => selectPart(item);

                card.innerHTML = `
                    <div class="h-32 w-full flex items-center justify-center bg-white rounded mb-2 overflow-hidden relative border border-gray-100">
                        <img src="${imgSrc}" class="img-contain transition-transform duration-300 group-hover:scale-110" loading="lazy" onerror="this.src='https://via.placeholder.com/150x150?text=Sin+Imagen'">
                    </div>
                    <h4 class="text-xs font-bold text-gray-800 leading-tight mb-1 line-clamp-2 h-8 flex items-center justify-center">${nombre}</h4>
                    <span class="text-[10px] text-gray-500 bg-gray-100 px-2 py-0.5 rounded-full font-mono mb-1 w-full truncate">${pn}</span>
                    <span class="text-[9px] text-blue-600 font-medium uppercase tracking-wide border border-blue-100 px-1 rounded">${cat}</span>
                `;
                container.appendChild(card);
            });
        }

        function selectPart(item) {
            document.getElementById('reg-repuesto-id').value = item.id_repuesto;
            document.getElementById('display-repuesto').value = item.nombre; 
            document.getElementById('reg-pn').value = item.num_part || 'S/N';
            
            const select = document.getElementById('reg-tipo');
            const exists = [...select.options].some(o => o.value === item.categoria);
            select.value = exists ? item.categoria : 'General';

            document.getElementById('img-preview').src = getImgUrl(item.imagen_url);
            toggleModal('modal-catalog');
            
            setTimeout(() => document.getElementById('reg-serie').focus(), 300);
        }

        // --- CRUD ---
        document.getElementById('registroForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const idRep = document.getElementById('reg-repuesto-id').value;
            if(!idRep) { alert("Seleccione un repuesto"); return; }
            document.getElementById('loading-overlay').classList.remove('hidden-force');

            try {
                // Insertar con tipo_maquina
                const { data: newItem, error } = await supabaseClient.from('estado_repu').insert([{
                    id_repuesto: idRep,
                    id_serie: document.getElementById('reg-serie').value,
                    cantidad: document.getElementById('reg-cantidad').value,
                    tecnico_manual: document.getElementById('reg-tecnico-1').value,
                    tecnico_visto_bueno: document.getElementById('reg-tecnico-2').value,
                    tipo_maquina: document.getElementById('reg-tipo').value,
                    estado: 'Por Atender', ubi_actual: 'Almacen-Produccion',
                    fecha_ingreso: new Date().toISOString(),
                    observaciones: 'Ingreso Registro Producción'
                }]).select();

                if(error) throw error;

                await supabaseClient.from('repuestos_movimientos').insert([{
                    id_item: newItem[0].id_estadorepu, id_repuesto: idRep,
                    accion: `Alta Producción: ${newItem[0].tecnico_manual}`, serie_texto: newItem[0].id_serie,
                    ubicacion_origen: 'Externo', ubicacion_destino: 'Almacen-Produccion', fecha_hora: new Date().toISOString()
                }]);

                alert("Registrado");
                document.getElementById('reg-serie').value = '';
                document.getElementById('reg-serie').focus();
                loadHistory(); 

            } catch (err) { alert("Error: " + err.message); } 
            finally { document.getElementById('loading-overlay').classList.add('hidden-force'); }
        });

        // Crear Nuevo 
        document.getElementById('form-new-part').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loading-overlay').classList.remove('hidden-force');
            const { error } = await supabaseClient.from('repuestos').insert([{
                Nombre: document.getElementById('new-nombre').value, 
                num_part: document.getElementById('new-pn').value, 
                Categoria: document.getElementById('new-categoria').value, 
                imagen_url: document.getElementById('new-img').value
            }]);
            document.getElementById('loading-overlay').classList.add('hidden-force');
            if(error) alert("Error: " + error.message);
            else {
                alert("Creado");
                toggleModal('modal-new-part');
                document.getElementById('form-new-part').reset();
                await refreshRepuestosList();
                openCatalogModal();
            }
        });

        // --- HISTORIAL ---
        async function loadHistory() {
            // Nota: Se pide 'observaciones' y 'num_part' para el Excel
            const { data } = await supabaseClient.from('estado_repu')
                .select(`id_estadorepu, id_serie, cantidad, tecnico_manual, tecnico_visto_bueno, fecha_ingreso, tipo_maquina, ubi_actual, observaciones, repuestos (nombre, num_part)`)
                .eq('ubi_actual', 'Almacen-Produccion')
                .order('fecha_ingreso', { ascending: false })
                .limit(50);
            fullHistoryData = data || [];
            renderHistoryTable('');
        }

        function renderHistoryTable(filter) {
            const tbody = document.querySelector('#table-history tbody');
            tbody.innerHTML = '';
            const filtered = fullHistoryData.filter(i => JSON.stringify(i).toLowerCase().includes(filter.toLowerCase()));
            
            if(filtered.length===0) { tbody.innerHTML='<tr><td colspan="7" class="p-8 text-center text-gray-400">Sin datos</td></tr>'; return; }

            filtered.forEach(i => {
                const date = new Date(i.fecha_ingreso).toLocaleDateString('es-PE', {day:'2-digit', month:'2-digit', hour:'2-digit', minute:'2-digit'});
                const repName = i.repuestos?.nombre || '-';
                
                tbody.innerHTML += `
                    <tr class="hover:bg-gray-50 border-b">
                        <td class="p-3 text-xs font-mono">${date}</td>
                        <td class="p-3 font-bold text-gray-800">${repName}</td>
                        <td class="p-3 font-mono text-blue-700">${i.id_serie || 'S/N'}</td>
                        <td class="p-3 text-xs text-purple-700">${i.tipo_maquina || '-'}</td>
                        <td class="p-3 text-xs">${i.tecnico_manual}</td>
                        <td class="p-3 text-xs font-bold text-blue-600">${i.ubi_actual}</td>
                        <td class="p-3 text-center flex justify-center gap-2">
                            <button onclick="openEditModal(${i.id_estadorepu})" class="text-blue-500 hover:bg-blue-100 p-2 rounded-full"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                            <button onclick="deleteRecord(${i.id_estadorepu})" class="text-red-500 hover:bg-red-100 p-2 rounded-full"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                        </td>
                    </tr>`;
            });
            if(window.lucide) lucide.createIcons();
        }

        window.deleteRecord = async (id) => {
            if(!confirm("¿Eliminar?")) return;
            const { error } = await supabaseClient.from('estado_repu').delete().eq('id_estadorepu', id);
            if(!error) loadHistory();
            else alert(error.message);
        };

        window.openEditModal = (id) => {
            const item = fullHistoryData.find(x => x.id_estadorepu == id);
            if(!item) return;
            
            document.getElementById('edit-id').value = id;
            document.getElementById('edit-serie').value = item.id_serie;
            document.getElementById('edit-cantidad').value = item.cantidad;
            document.getElementById('edit-tecnico-1').value = item.tecnico_manual;
            document.getElementById('edit-tecnico-2').value = item.tecnico_visto_bueno;
            document.getElementById('edit-tipo').value = item.tipo_maquina || 'General';
            document.getElementById('edit-obs').value = item.observaciones || '';
            
            toggleModal('modal-edit-record');
        };

        document.getElementById('form-edit-record').addEventListener('submit', async (e) => {
            e.preventDefault();
            document.getElementById('loading-overlay').classList.remove('hidden-force');
            const id = document.getElementById('edit-id').value;
            const updates = {
                id_serie: document.getElementById('edit-serie').value,
                cantidad: document.getElementById('edit-cantidad').value,
                tecnico_manual: document.getElementById('edit-tecnico-1').value,
                tecnico_visto_bueno: document.getElementById('edit-tecnico-2').value,
                tipo_maquina: document.getElementById('edit-tipo').value,
                observaciones: document.getElementById('edit-obs').value
            };
            const { error } = await supabaseClient.from('estado_repu').update(updates).eq('id_estadorepu', id);
            document.getElementById('loading-overlay').classList.add('hidden-force');
            if(error) alert(error.message);
            else { toggleModal('modal-edit-record'); loadHistory(); }
        });

        // --- EXPORTAR EXCEL ACTUALIZADO ---
        window.exportToExcel = async () => {
            document.getElementById('loading-overlay').classList.remove('hidden-force');
            // Consultamos todos los campos que el usuario pidió
            const { data } = await supabaseClient.from('estado_repu')
                .select(`id_serie, cantidad, tecnico_manual, tecnico_visto_bueno, fecha_ingreso, estado, ubi_actual, tipo_maquina, observaciones, repuestos (nombre, num_part)`)
                .eq('ubi_actual', 'Almacen-Produccion')
                .order('fecha_ingreso', { ascending: false });
            
            if(!data) { document.getElementById('loading-overlay').classList.add('hidden-force'); return; }
            
            const rows = data.map(i => ({ 
                "Fecha y Hora": new Date(i.fecha_ingreso).toLocaleString('es-PE'), 
                "Repuesto": i.repuestos?.nombre, 
                "P/N": i.repuestos?.num_part,
                "Serie": i.id_serie, 
                "Cant": i.cantidad, 
                "Tipo": i.tipo_maquina,
                "Registrado Por": i.tecnico_manual, 
                "Visto Bueno": i.tecnico_visto_bueno,
                "Observaciones": i.observaciones,
                "Ubicación": i.ubi_actual 
            }));
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, XLSX.utils.json_to_sheet(rows), "Produccion");
            XLSX.writeFile(wb, `Reporte_Produccion_${new Date().toISOString().slice(0,10)}.xlsx`);
            document.getElementById('loading-overlay').classList.add('hidden-force');
        };

        window.toggleModal = (id) => {
            const el = document.getElementById(id);
            el.classList.toggle('hidden-force');
        };
    </script>
</body>
</html>